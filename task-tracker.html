<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#5eada6">
    <meta name="description" content="Daily Task and Quote Tracker for Tech Sales">
    <link rel="manifest" href="manifest.json">
    <title>Daily Task Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f4f1ec;
            --bg-secondary: #faf8f5;
            --bg-tertiary: #ffffff;
            --text-primary: #2d2d2d;
            --text-secondary: #6b6b6b;
            --accent: #5eada6;
            --accent-dim: #5eada633;
            --accent-light: #e0f2f1;
            --border: #e8e3db;
            --danger: #dc2626;
            --warning: #ea580c;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #f9f6f1 0%, #f4f1ec 50%, #ede8e0 100%);
            color: var(--text-primary);
            line-height: 1.7;
            min-height: 100vh;
            background-attachment: fixed;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 50px 30px;
        }

        header {
            margin-bottom: 60px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 40px;
        }

        .briefing-buttons {
            display: flex;
            gap: 10px;
            margin-top: 18px;
        }

        .btn-briefing {
            padding: 8px 18px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.15s ease;
        }

        .btn-briefing:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .briefing-panel {
            position: fixed;
            top: 0; right: -480px;
            width: 460px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            z-index: 1500;
            display: flex;
            flex-direction: column;
            box-shadow: -8px 0 32px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
            overflow: hidden;
        }

        .briefing-panel.open {
            right: 0;
        }

        .briefing-header {
            padding: 28px 28px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .briefing-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .briefing-subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .briefing-close {
            background: transparent;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            min-width: auto;
            line-height: 1;
        }

        .briefing-body {
            padding: 20px 28px;
            overflow-y: auto;
            flex: 1;
        }

        .briefing-section {
            margin-bottom: 28px;
        }

        .briefing-section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        .briefing-item {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            padding: 9px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            gap: 12px;
            cursor: pointer;
        }

        .briefing-item:hover .briefing-item-title {
            color: var(--accent);
        }

        .briefing-item-title {
            font-size: 0.9rem;
            color: var(--text-primary);
            flex: 1;
            transition: color 0.15s;
        }

        .briefing-item-sub {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .briefing-empty {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
            padding: 6px 0;
        }

        .briefing-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.25);
            z-index: 1499;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .briefing-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        /* PDF Preview Modal */
        .pdf-preview-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .pdf-preview-modal.open {
            display: flex;
        }

        .pdf-preview-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .pdf-preview-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-preview-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .pdf-preview-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            min-width: auto;
        }

        .pdf-preview-body {
            flex: 1;
            overflow: hidden;
        }

        .pdf-preview-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* PDF Context Menu */
        .pdf-context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            display: none;
            min-width: 180px;
        }

        .pdf-context-menu.open {
            display: block;
        }

        .pdf-context-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
        }

        .pdf-context-item:last-child {
            border-bottom: none;
        }

        .pdf-context-item:hover {
            background: rgba(94, 173, 166, 0.1);
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .date-display {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .stat-box {
            background: var(--bg-secondary);
            padding: 20px 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            flex: 1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .stat-box.clickable {
            cursor: pointer;
        }

        .stat-box.clickable:hover {
            box-shadow: 0 6px 20px rgba(94, 173, 166, 0.15);
            transform: translateY(-3px);
            border-color: var(--accent);
        }

        .search-container {
            position: fixed;
            top: 28px;
            right: 90px;
            z-index: 1000;
            display: flex;
            justify-content: flex-end;
        }

        .search-box {
            position: relative;
            transition: all 0.3s ease;
        }

        .search-toggle {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(94, 173, 166, 0.2);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.3rem;
            color: var(--accent);
        }

        .search-toggle:hover {
            background: rgba(255, 255, 255, 0.6);
            border-color: var(--accent);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(94, 173, 166, 0.15);
        }

        .search-box.expanded .search-toggle {
            display: none;
        }

        .search-input-wrapper {
            display: none;
            align-items: center;
            gap: 8px;
        }

        .search-box.expanded .search-input-wrapper {
            display: flex;
        }

        .search-input {
            width: 300px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px 15px;
            border-radius: 25px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim), 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .search-icon {
            display: none;
        }

        .close-search {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(94, 173, 166, 0.2);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.2rem;
            color: var(--text-secondary);
            padding: 0;
            min-width: auto;
        }

        .close-search:hover {
            background: rgba(255, 255, 255, 0.6);
            border-color: var(--accent);
            color: var(--accent);
            transform: scale(1.05);
            box-shadow: none;
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--accent);
            pointer-events: none;
            z-index: 9999;
            animation: confetti-fall 1.5s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(300px) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti:nth-child(2n) {
            background: #ff6b9d;
            animation-duration: 1.8s;
        }

        .confetti:nth-child(3n) {
            background: #feca57;
            animation-duration: 1.6s;
        }

        .confetti:nth-child(4n) {
            background: #48dbfb;
            animation-duration: 2s;
        }

        .confetti:nth-child(5n) {
            background: #1dd1a1;
            animation-duration: 1.7s;
        }

        /* Google Drive Sync */
        .sync-status {
            position: fixed;
            top: 22px;
            right: 145px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 999;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .sync-status.syncing {
            border-color: var(--accent);
            background: rgba(94, 173, 166, 0.1);
        }

        .sync-status.error {
            border-color: var(--danger);
            background: rgba(220, 38, 38, 0.1);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .sync-dot.connected {
            background: var(--accent);
            animation: pulse-sync 2s infinite;
        }

        .sync-dot.syncing {
            background: var(--accent);
            animation: pulse-fast 0.5s infinite;
        }

        .sync-dot.error {
            background: var(--danger);
        }

        @keyframes pulse-sync {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-fast {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .sync-button {
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            font-family: 'DM Sans', sans-serif;
        }

        .sync-button:hover {
            background: var(--accent-light);
            color: var(--accent);
            transform: none;
            box-shadow: none;
        }

        .backup-buttons {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 10px;
            z-index: 999;
        }

        .backup-btn {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'DM Sans', sans-serif;
            color: var(--text-primary);
        }

        .backup-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(94, 173, 166, 0.3);
            transform: translateY(-2px);
        }

        .backup-btn:active {
            transform: translateY(0);
        }

        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            font-size: 1.2rem;
            line-height: 1;
            display: none;
        }

        .clear-search:hover {
            color: var(--accent);
            background: transparent;
            transform: translateY(-50%);
            box-shadow: none;
        }

        .clear-search.visible {
            display: block;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.due { color: #dc2626; }
        .stat-value.open { color: var(--accent); }

        .add-task-section {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 50px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            cursor: move;
            transition: all 0.3s ease;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px 15px;
            border-radius: 6px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'DM Sans', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            background: #4d9892;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(94, 173, 166, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--accent);
            border-radius: 2px;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .task-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .task-card-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .task-card-expanded {
            display: none;
            padding-top: 12px;
            margin-top: 10px;
            border-top: 1px solid var(--border);
        }

        .task-card.expanded .task-card-expanded {
            display: block;
        }

        .task-card.expanded {
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(94, 173, 166, 0.12);
        }

        /* Three dot menu */
        .btn-menu:hover {
            background: var(--accent-light);
            color: var(--accent);
            border-color: var(--accent);
            transform: none;
            box-shadow: none;
        }

        .dot-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 140px;
            overflow: hidden;
            display: none;
        }

        .dot-menu.active {
            display: block;
        }

        .dot-menu-item {
            padding: 10px 15px;
            font-size: 0.85rem;
            cursor: pointer;
            color: var(--text-primary);
            transition: background 0.15s ease;
            display: block;
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            font-family: 'DM Sans', sans-serif;
        }

        .dot-menu-item:hover {
            background: var(--accent-light);
            color: var(--accent);
            transform: none;
            box-shadow: none;
        }

        /* Efforts Styles */
        .effort-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0;
            margin-bottom: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .effort-card:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 12px rgba(94, 173, 166, 0.12);
        }

        .effort-card.expanded {
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(94, 173, 166, 0.12);
        }

        .effort-card-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
        }

        .effort-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .effort-customer {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .effort-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            white-space: nowrap;
            flex-shrink: 0;
            width: 320px;
        }

        .effort-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 56px;
            text-align: center;
        }

        .effort-status.active { background: rgba(94,173,166,0.15); color: var(--accent); }
        .effort-status.won    { background: rgba(22,163,74,0.15);   color: #16a34a; }
        .effort-status.lost   { background: rgba(220,38,38,0.15);   color: #dc2626; }

        .effort-priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(232, 98, 58, 0.15);
            color: #e8623a;
            flex-shrink: 0;
            width: 112px;
            text-align: center;
        }

        .effort-card.high-priority {
            border-left: 4px solid #e8623a;
        }

        .effort-expanded {
            display: none;
            padding: 0 15px 15px 15px;
            border-top: 1px solid var(--border);
            margin-top: 0;
        }

        .effort-card.expanded .effort-expanded {
            display: block;
        }

        .effort-section-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin: 14px 0 8px 0;
        }

        .effort-linked-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.15s ease, border-color 0.15s ease;
            border: 1px solid transparent;
        }

        .effort-linked-item:hover {
            background: var(--accent-light);
            border-color: var(--accent);
        }

        .effort-linked-item:hover .item-label {
            color: var(--accent);
        }

        .effort-linked-item .item-label {
            flex: 1;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .effort-linked-item .item-meta {
            color: var(--text-secondary);
            font-size: 0.78rem;
            white-space: nowrap;
        }

        .effort-empty {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-style: italic;
            padding: 6px 0;
        }

        .effort-notes-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.6;
            margin-top: 4px;
        }

        .effort-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            padding: 20px;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 35px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--text-primary);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 5px 10px;
            min-width: auto;
        }

        .modal-close:hover {
            color: var(--accent);
            background: transparent;
            transform: none;
            box-shadow: none;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .btn-cancel-edit {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 10px 20px;
        }

        .btn-cancel-edit:hover {
            background: var(--border);
            transform: none;
            box-shadow: none;
        }

        .expanded-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .expanded-value {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .expanded-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .task-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .task-card.overdue::before {
            opacity: 1;
            background: #dc2626;
        }

        .task-card.due-today::before {
            opacity: 1;
            background: #ea580c;
        }

        .task-card:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 12px rgba(94, 173, 166, 0.12);
        }

        .task-header {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 12px;
            min-width: 0;
        }

        .task-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 150px;
            flex: 1;
        }

        .task-description {
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 2;
            margin-bottom: 0;
            line-height: 1.4;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            flex-shrink: 0;
            width: 380px;
            align-items: center;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .meta-label {
            opacity: 0.6;
        }

        .task-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .btn-complete,
        .btn-delete,
        .btn-menu {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-complete:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-delete:hover {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .quote-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100px;
            text-align: center;
            flex-shrink: 0;
        }

        .quote-type-badge.new {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .quote-type-badge.renewal {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
        }

        .task-card.quote-new {
            border-left: 4px solid #3b82f6;
        }

        .task-card.quote-renewal {
            border-left: 4px solid #a855f7;
        }

        /* Quote Styles */
        .quote-ref {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .quote-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quote-status.active {
            background: rgba(94, 173, 166, 0.1);
            color: var(--accent);
        }

        .quote-status.closed-won {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .quote-status.closed-lost {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }

        .quote-amount {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .follow-up-alert {
            background: rgba(234, 88, 12, 0.1);
            border-left: 3px solid #ea580c;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: #ea580c;
            font-weight: 500;
        }

        .quote-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-won,
        .btn-lost {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: transparent;
            border: 1px solid var(--border);
        }

        .btn-won {
            color: #22c55e;
            border-color: #22c55e;
        }

        .btn-won:hover {
            background: #22c55e;
            color: white;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }

        .btn-lost {
            color: #dc2626;
            border-color: #dc2626;
        }

        .btn-lost:hover {
            background: #dc2626;
            color: white;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        .btn-snooze {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            position: relative;
        }

        .btn-snooze:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--text-secondary);
            box-shadow: none;
        }

        .snooze-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 8px;
            margin-top: 4px;
            z-index: 1000;
            display: none;
            min-width: 140px;
        }

        .snooze-menu.active {
            display: block;
        }

        .snooze-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
        }

        .snooze-option:hover {
            background: var(--accent-light);
            color: var(--accent);
            transform: none;
            box-shadow: none;
        }

        .customer-group {
            margin-bottom: 35px;
        }

        .customer-header {
            background: var(--bg-tertiary);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .customer-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .customer-stats {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .customer-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .minimize-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 5px 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: auto;
            line-height: 1;
        }

        .minimize-btn:hover {
            color: var(--accent);
            background: transparent;
            transform: none;
            box-shadow: none;
        }

        .form-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .form-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        .draggable-box.has-collapsed-content {
            padding: 25px !important;
        }

        .draggable-box.has-collapsed-content .section-header {
            margin-bottom: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            cursor: move;
            min-height: 40px;
        }

        .calendar-mini {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 50px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            cursor: move;
            transition: all 0.3s ease;
        }

        .calendar-mini:hover,
        .add-task-section:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .calendar-mini.dragging,
        .add-task-section.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .drag-handle {
            cursor: move;
            color: var(--text-secondary);
            font-size: 1.2rem;
            margin-right: 10px;
            user-select: none;
        }

        .drag-handle:hover {
            color: var(--accent);
        }

        #draggableContainer {
            position: relative;
        }

        /* Calendar Styles */
        .calendar-view {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .calendar-month {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 16px;
            font-size: 0.9rem;
            min-width: auto;
        }

        .nav-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: none;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: var(--bg-tertiary);
            padding: 12px;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            background: var(--bg-secondary);
            min-height: 100px;
            padding: 8px;
            position: relative;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background: var(--bg-tertiary);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: var(--accent-light);
        }

        .day-number {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .today .day-number {
            background: var(--accent);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .calendar-task {
            font-size: 0.7rem;
            padding: 3px 6px;
            margin-bottom: 3px;
            border-radius: 3px;
            background: var(--accent-light);
            color: var(--accent);
            border-left: 2px solid var(--accent);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-task:hover {
            background: var(--accent);
            color: white;
        }

        .calendar-task.overdue {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
            border-left-color: #dc2626;
        }

        .calendar-task.overdue:hover {
            background: var(--danger);
            color: white;
        }

        .task-count {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .view-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0;
        }

        .view-tab {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 10px 20px;
            border-bottom: 2px solid transparent;
            text-transform: none;
            letter-spacing: 0;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .view-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .view-tab:hover {
            background: transparent;
            color: var(--text-primary);
            transform: none;
            box-shadow: none;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0;
        }

        .filter-tab {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 10px 20px;
            border-bottom: 2px solid transparent;
            text-transform: none;
            letter-spacing: 0;
            font-weight: 500;
        }

        .filter-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .filter-tab:hover {
            background: transparent;
            color: var(--text-primary);
            transform: none;
            box-shadow: none;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .badge.overdue {
            background: rgba(220, 38, 38, 0.15);
            color: #dc2626;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .badge.today {
            background: rgba(234, 88, 12, 0.15);
            color: #ea580c;
            font-weight: 700;
        }

        .badge.snoozed {
            background: rgba(100, 116, 139, 0.15);
            color: #64748b;
            font-weight: 700;
        }

        @media (max-width: 600px) {
            .stats {
                flex-direction: column;
            }

            h1 {
                font-size: 2rem;
            }

            .task-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Daily Task Tracker</h1>
            <div class="date-display" id="currentDate"></div>
            <div class="stats">
                <div class="stat-box clickable" onclick="taskManager.goToDueToday()">
                    <div class="stat-label">Due Today</div>
                    <div class="stat-value due" id="dueToday">0</div>
                </div>
                <div class="stat-box clickable" onclick="taskManager.goToAllTasks()">
                    <div class="stat-label">Open Tasks</div>
                    <div class="stat-value open" id="openTasks">0</div>
                </div>
                <div class="stat-box clickable" onclick="taskManager.goToFollowUpQuotes()">
                    <div class="stat-label">Quotes Need Follow-up</div>
                    <div class="stat-value due" id="followUpQuotesTop">0</div>
                </div>
            </div>
            <div class="briefing-buttons">
                <button class="btn-briefing" onclick="taskManager.openBriefing('morning')">‚òÄ Morning Briefing</button>
                <button class="btn-briefing" onclick="taskManager.openBriefing('eod')">‚òΩ End of Day</button>
            </div>
        </header>

        <div class="search-container">
            <div class="search-box" id="searchBox">
                <div class="search-toggle" id="searchToggle">
                    üîç
                </div>
                <div class="search-input-wrapper">
                    <input 
                        type="text" 
                        id="globalSearch" 
                        class="search-input" 
                        placeholder="Search tasks and quotes..."
                    >
                    <button class="close-search" id="closeSearch">√ó</button>
                </div>
            </div>
        </div>

        <div class="sync-status" id="syncStatus">
            <div class="sync-dot" id="syncDot"></div>
            <span id="syncText">Not connected</span>
            <button class="sync-button" id="syncButton">Connect Google Drive</button>
        </div>

        <div class="backup-buttons">
            <button class="backup-btn" id="exportBtn">üìä Export to Excel</button>
        </div>

        <!-- Edit Task Modal -->
        <div class="modal-overlay hidden" id="editTaskModal">
            <div class="modal">
                <button class="modal-close" onclick="taskManager.closeEditModal()">√ó</button>
                <div class="modal-title">Edit Task</div>
                <div class="input-group">
                    <label for="editTaskTitle">Task Title</label>
                    <input type="text" id="editTaskTitle" placeholder="Enter task title...">
                </div>
                <div class="input-group">
                    <label for="editTaskCustomer">Customer (Optional)</label>
                    <input type="text" id="editTaskCustomer" placeholder="e.g. Acme Corp">
                </div>
                <div class="input-group">
                    <label for="editTaskDescription">Description (Optional)</label>
                    <textarea id="editTaskDescription" placeholder="Add details about this task..."></textarea>
                </div>
                <div class="input-group">
                    <label for="editTaskDueDate">Due Date (Optional)</label>
                    <input type="date" id="editTaskDueDate">
                </div>
                <div class="input-group">
                    <label for="editTaskPOC">Point of Contact (Optional)</label>
                    <input type="text" id="editTaskPOC" placeholder="e.g. John Smith">
                </div>
                <div class="input-group">
                    <label for="editTaskEffort">Link to Effort (Optional)</label>
                    <select id="editTaskEffort" style="width:100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 15px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;">
                        <option value="">‚Äî No effort ‚Äî</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel-edit" onclick="taskManager.closeEditModal()">Cancel</button>
                    <button onclick="taskManager.saveEditTask()">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Edit Quote Modal -->
        <div class="modal-overlay hidden" id="editQuoteModal">
            <div class="modal">
                <button class="modal-close" onclick="taskManager.closeEditQuoteModal()">√ó</button>
                <div class="modal-title">Edit Quote</div>
                <div class="input-group">
                    <label for="editQuoteReference">Quote Reference</label>
                    <input type="text" id="editQuoteReference" placeholder="e.g. TAD021026-01">
                </div>
                <div class="input-group">
                    <label for="editQuoteCustomer">Customer Name</label>
                    <input type="text" id="editQuoteCustomer" placeholder="Enter customer name...">
                </div>
                <div class="input-group">
                    <label for="editQuoteAmount">Quote Amount</label>
                    <input type="text" id="editQuoteAmount" placeholder="e.g. $5,000">
                </div>
                <div class="input-group">
                    <label for="editQuoteType">Quote Type</label>
                    <select id="editQuoteType" style="width:100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 15px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;">
                        <option value="new">New Business</option>
                        <option value="renewal">Renewal</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="editQuoteSentDate">Date Sent</label>
                    <input type="date" id="editQuoteSentDate">
                </div>
                <div class="input-group">
                    <label for="editQuoteNotes">Notes (Optional)</label>
                    <textarea id="editQuoteNotes" placeholder="Add notes..."></textarea>
                </div>
                <div class="input-group">
                    <label for="editQuotePOC">Point of Contact (Optional)</label>
                    <input type="text" id="editQuotePOC" placeholder="e.g. John Smith">
                </div>
                <div class="input-group">
                    <label for="editQuoteEffort">Link to Effort (Optional)</label>
                    <select id="editQuoteEffort" style="width:100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 15px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;">
                        <option value="">‚Äî No effort ‚Äî</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="editQuoteReminderInterval">Follow-up Reminder Interval</label>
                    <select id="editQuoteReminderInterval" style="width:100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 15px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;">
                        <option value="0">No follow-up</option>
                        <option value="7">1 week</option>
                        <option value="14">2 weeks</option>
                        <option value="21">3 weeks</option>
                        <option value="28">4 weeks</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel-edit" onclick="taskManager.closeEditQuoteModal()">Cancel</button>
                    <button onclick="taskManager.saveEditQuote()">Save Changes</button>
                </div>
            </div>
        </div>

        <div id="draggableContainer">
            <div class="add-task-section draggable-box" data-box-id="taskForm" draggable="false">
                <div class="section-header">
                    <h2 class="section-title" style="margin-bottom: 0;">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>Add New Task
                    </h2>
                    <button class="minimize-btn" id="toggleTaskForm" onclick="taskManager.toggleSection('taskForm')">‚àí</button>
                </div>
                <div id="taskFormContent" class="form-content">
                    <form id="addTaskForm">
                        <div class="input-group">
                            <label for="taskTitle">Task Title</label>
                            <input type="text" id="taskTitle" required placeholder="Enter task title...">
                        </div>
                        <div class="input-group">
                            <label for="taskCustomer">Customer (Optional)</label>
                            <input type="text" id="taskCustomer" placeholder="e.g. Acme Corp">
                        </div>
                        <div class="input-group">
                            <label for="taskDescription">Description (Optional)</label>
                            <textarea id="taskDescription" placeholder="Add details about this task..."></textarea>
                        </div>
                        <div class="input-group">
                            <label for="taskDueDate">Due Date (Optional - leave blank for open-ended)</label>
                            <input type="date" id="taskDueDate">
                        </div>
                        <div class="input-group">
                            <label for="taskPOC">Point of Contact (Optional)</label>
                            <input type="text" id="taskPOC" placeholder="e.g. John Smith">
                        </div>
                        <div class="input-group">
                            <label for="taskEffort">Link to Effort (Optional)</label>
                            <select id="taskEffort" style="width:100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 15px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;">
                                <option value="">‚Äî No effort ‚Äî</option>
                            </select>
                        </div>
                        <button type="submit">Add Task</button>
                    </form>
                </div>
            </div>

            <div class="add-task-section draggable-box" data-box-id="quoteForm" draggable="false">
                <div class="section-header">
                    <h2 class="section-title" style="margin-bottom: 0;">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>Track New Quote
                    </h2>
                    <button class="minimize-btn" id="toggleQuoteForm" onclick="taskManager.toggleSection('quoteForm')">‚àí</button>
                </div>
                <div id="quoteFormContent" class="form-content">
                <form id="quoteForm">
                    <div class="input-group">
                        <label for="quoteRef">Quote Reference</label>
                        <input type="text" id="quoteRef" required placeholder="e.g., TAD021026-01A">
                    </div>
                    <div class="input-group">
                        <label for="customerName">Customer Name</label>
                        <input type="text" id="customerName" required placeholder="Enter customer name...">
                    </div>
                    <div class="input-group">
                        <label for="quoteAmount">Quote Amount (Optional)</label>
                        <input type="text" id="quoteAmount" placeholder="e.g., $5,000">
                    </div>
                    <div class="input-group">
                        <label for="quoteType">Quote Type</label>
                        <select id="quoteType" style="width:100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 15px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;">
                            <option value="new">New Business</option>
                            <option value="renewal">Renewal</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="quoteNotes">Notes (Optional)</label>
                        <textarea id="quoteNotes" placeholder="Add any notes about this quote..."></textarea>
                    </div>
                    <div class="input-group">
                        <label for="quotePOC">Point of Contact (Optional)</label>
                        <input type="text" id="quotePOC" placeholder="e.g. John Smith">
                    </div>
                    <div class="input-group">
                        <label for="quoteSentDate">Date Sent</label>
                        <input type="date" id="quoteSentDate" required>
                    </div>
                    <div class="input-group">
                        <label for="quoteEffort">Link to Effort (Optional)</label>
                        <select id="quoteEffort" style="width:100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 15px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;">
                            <option value="">‚Äî No effort ‚Äî</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="quoteReminderInterval">Follow-up Reminder Interval</label>
                        <select id="quoteReminderInterval" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 15px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;">
                            <option value="0">No follow-up</option>
                            <option value="7">1 week</option>
                            <option value="14">2 weeks</option>
                            <option value="21" selected>3 weeks</option>
                            <option value="28">4 weeks</option>
                        </select>
                    </div>
                    <button type="submit">Add Quote</button>
                </form>
            </div>
        </div>
        </div>

        <div class="view-tabs">
            <button class="view-tab active" data-view="list">Tasks</button>
            <button class="view-tab" data-view="quotes">Quotes</button>
            <button class="view-tab" data-view="efforts">Efforts</button>
        </div>

        <div id="listView" class="content-section active">
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">All Tasks</button>
                <button class="filter-tab" data-filter="today">Due Today</button>
                <button class="filter-tab" data-filter="overdue">Overdue</button>
                <button class="filter-tab" data-filter="open-ended">Open-Ended</button>
            </div>

            <div id="taskList" class="task-list"></div>
        </div>

        <div id="calendarView" class="content-section">
            <div class="calendar-view">
                <div class="calendar-header">
                    <div class="calendar-month" id="calendarMonth"></div>
                    <div class="calendar-nav">
                        <button class="nav-btn" id="prevMonth">‚Üê Previous</button>
                        <button class="nav-btn" id="todayBtn">Today</button>
                        <button class="nav-btn" id="nextMonth">Next ‚Üí</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>

        <div id="quotesView" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title" style="margin-bottom: 0;">Quote Tracker</h2>
                <button id="exportQuotesBtn" style="padding: 10px 20px; font-size: 0.9rem;">
                    üìä Export to Excel
                </button>
            </div>
            
            <div class="stats" style="margin-bottom: 30px;">
                <div class="stat-box">
                    <div class="stat-label">Active Quotes</div>
                    <div class="stat-value open" id="activeQuotes">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Follow Up</div>
                    <div class="stat-value due" id="followUpQuotes">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Open Value</div>
                    <div class="stat-value" id="totalQuoteValue" style="color: var(--accent);">$0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Won This Month</div>
                    <div class="stat-value" id="monthlyWonValue" style="color: #16a34a;">$0</div>
                </div>
            </div>

            <div class="filter-tabs">
                <button class="filter-tab active" data-quote-filter="open">Open Quotes</button>
                <button class="filter-tab" data-quote-filter="follow-up">Follow Up</button>
                <button class="filter-tab" data-quote-filter="closed">Closed</button>
            </div>

            <div id="quoteList" class="task-list"></div>
        </div>

        <!-- Efforts View -->
        <div id="effortsView" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title" style="margin-bottom: 0;">Efforts</h2>
                <button onclick="taskManager.openNewEffortModal()" style="padding: 10px 20px; font-size: 0.9rem;">+ New Effort</button>
            </div>

            <div class="filter-tabs">
                <button class="filter-tab active" data-effort-filter="active">Active</button>
                <button class="filter-tab" data-effort-filter="won">Won</button>
                <button class="filter-tab" data-effort-filter="lost">Lost</button>
                <button class="filter-tab" data-effort-filter="all">All</button>
            </div>

            <div id="effortList" class="task-list" style="margin-top: 20px;"></div>
        </div>

        <!-- New/Edit Effort Modal -->
        <div class="modal-overlay hidden" id="effortModal">
            <div class="modal">
                <button class="modal-close" onclick="taskManager.closeEffortModal()">√ó</button>
                <div class="modal-title" id="effortModalTitle">New Effort</div>
                <div class="input-group">
                    <label for="effortName">Effort / Deal Name</label>
                    <input type="text" id="effortName" placeholder="e.g. Lego Harry Potter">
                </div>
                <div class="input-group">
                    <label for="effortCustomer">Customer</label>
                    <input type="text" id="effortCustomer" placeholder="e.g. Lego">
                </div>
                <div class="input-group">
                    <label for="effortStatus">Status</label>
                    <select id="effortStatus" style="width:100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 15px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;">
                        <option value="active">Active</option>
                        <option value="won">Won</option>
                        <option value="lost">Lost</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="effortNotes">Notes (Optional)</label>
                    <textarea id="effortNotes" placeholder="Add context about this deal..."></textarea>
                </div>
                <div class="input-group" style="display:flex; align-items:center; gap:12px;">
                    <input type="checkbox" id="effortHighPriority" style="width:18px; height:18px; accent-color: #e8623a; cursor:pointer; flex-shrink:0;">
                    <label for="effortHighPriority" style="margin:0; cursor:pointer; font-size:0.95rem;">High Priority</label>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel-edit" onclick="taskManager.closeEffortModal()">Cancel</button>
                    <button onclick="taskManager.saveEffort()">Save Effort</button>
                </div>
            </div>
        </div>

    <script>
        // Google Drive Configuration - YOU NEED TO UPDATE THIS
        const GOOGLE_DRIVE_CONFIG = {
            clientId: '138476067551-ofqrldumr38te4fn3l6jp426ua0a02tu.apps.googleusercontent.com',
            apiKey: 'AIzaSyAfPjDr4c9a6E7m44XA1T6ct9__BKYzOMQ',
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            scopes: 'https://www.googleapis.com/auth/drive.file'
        };

        // Google Drive Sync Manager
        class GoogleDriveSync {
            constructor() {
                this.isSignedIn = false;
                this.fileName = 'task-tracker-data.json';
                this.fileId = null;
                this.isSyncing = false;
                this.syncInterval = null;
                this.initClient();
            }

            initClient() {
                if (GOOGLE_DRIVE_CONFIG.clientId === 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com') {
                    console.log('Google Drive not configured. Please add your Client ID.');
                    return;
                }

                gapi.load('client:auth2', () => {
                    gapi.client.init({
                        apiKey: GOOGLE_DRIVE_CONFIG.apiKey,
                        clientId: GOOGLE_DRIVE_CONFIG.clientId,
                        discoveryDocs: GOOGLE_DRIVE_CONFIG.discoveryDocs,
                        scope: GOOGLE_DRIVE_CONFIG.scopes
                    }).then(() => {
                        // Listen for sign-in state changes
                        gapi.auth2.getAuthInstance().isSignedIn.listen((isSignedIn) => {
                            this.updateSignInStatus(isSignedIn);
                        });

                        // Handle initial sign-in state
                        this.updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                    }).catch(error => {
                        console.error('Error initializing Google Drive:', error);
                        this.updateSyncStatus('error', 'Init failed');
                    });
                });
            }

            updateSignInStatus(isSignedIn) {
                this.isSignedIn = isSignedIn;
                
                if (isSignedIn) {
                    this.updateSyncStatus('connected', 'Connected to Drive');
                    this.syncData();
                    this.startAutoSync();
                } else {
                    this.updateSyncStatus('disconnected', 'Not connected');
                    this.stopAutoSync();
                }
            }

            signIn() {
                if (!gapi.auth2) {
                    alert('Google Drive sync is not configured. Please follow the setup instructions.');
                    return;
                }
                gapi.auth2.getAuthInstance().signIn();
            }

            signOut() {
                if (gapi.auth2) {
                    gapi.auth2.getAuthInstance().signOut();
                }
            }

            async syncData() {
                if (this.isSyncing || !this.isSignedIn) return;
                
                this.isSyncing = true;
                this.updateSyncStatus('syncing', 'Syncing...');

                try {
                    // Get local data
                    const localData = {
                        tasks: JSON.parse(localStorage.getItem('dailyTasks') || '[]'),
                        quotes: JSON.parse(localStorage.getItem('salesQuotes') || '[]'),
                        efforts: JSON.parse(localStorage.getItem('efforts') || '[]'),
                        collapsedSections: JSON.parse(localStorage.getItem('collapsedSections') || '{}'),
                        boxOrder: JSON.parse(localStorage.getItem('boxOrder') || '["taskForm","quoteForm"]'),
                        lastModified: new Date().toISOString()
                    };

                    // Find or create the file
                    if (!this.fileId) {
                        await this.findOrCreateFile();
                    }

                    // Get remote data
                    const remoteData = await this.downloadFile();

                    if (remoteData) {
                        // Compare timestamps and use the newer one
                        const useRemote = !localData.lastModified || 
                                        (remoteData.lastModified && new Date(remoteData.lastModified) > new Date(localData.lastModified));
                        
                        if (useRemote) {
                            // Remote is newer, update local
                            localStorage.setItem('dailyTasks', JSON.stringify(remoteData.tasks || []));
                            localStorage.setItem('salesQuotes', JSON.stringify(remoteData.quotes || []));
                            localStorage.setItem('efforts', JSON.stringify(remoteData.efforts || []));
                            localStorage.setItem('collapsedSections', JSON.stringify(remoteData.collapsedSections || {}));
                            localStorage.setItem('boxOrder', JSON.stringify(remoteData.boxOrder || ['taskForm','quoteForm']));
                            
                            // Refresh UI
                            if (window.taskManager) {
                                window.taskManager.tasks = remoteData.tasks || [];
                                window.taskManager.quotes = remoteData.quotes || [];
                                window.taskManager.efforts = remoteData.efforts || [];
                                window.taskManager.collapsedSections = remoteData.collapsedSections || {};
                                window.taskManager.boxOrder = remoteData.boxOrder || ['taskForm','quoteForm'];
                                window.taskManager.updateDisplay();
                                window.taskManager.populateEffortDropdowns();
                                window.taskManager.restoreCollapsedSections();
                                window.taskManager.restoreBoxOrder();
                            }
                        } else {
                            // Local is newer, upload
                            await this.uploadFile(localData);
                        }
                    } else {
                        // No remote file, upload local
                        await this.uploadFile(localData);
                    }

                    this.updateSyncStatus('connected', 'Synced');
                    
                } catch (error) {
                    console.error('Sync error:', error);
                    this.updateSyncStatus('error', 'Sync failed');
                } finally {
                    this.isSyncing = false;
                }
            }

            async findOrCreateFile() {
                try {
                    // Search for existing file
                    const response = await gapi.client.drive.files.list({
                        q: `name='${this.fileName}' and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id, name)'
                    });

                    if (response.result.files && response.result.files.length > 0) {
                        this.fileId = response.result.files[0].id;
                    } else {
                        // Create new file
                        const fileMetadata = {
                            name: this.fileName,
                            mimeType: 'application/json'
                        };
                        
                        const createResponse = await gapi.client.drive.files.create({
                            resource: fileMetadata,
                            fields: 'id'
                        });
                        
                        this.fileId = createResponse.result.id;
                    }
                } catch (error) {
                    console.error('Error finding/creating file:', error);
                    throw error;
                }
            }

            async downloadFile() {
                if (!this.fileId) return null;

                try {
                    const response = await gapi.client.drive.files.get({
                        fileId: this.fileId,
                        alt: 'media'
                    });

                    return response.result;
                } catch (error) {
                    console.error('Error downloading file:', error);
                    return null;
                }
            }

            async uploadFile(data) {
                if (!this.fileId) return;

                try {
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";

                    const contentType = 'application/json';
                    const metadata = {
                        mimeType: contentType
                    };

                    const multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: ' + contentType + '\r\n\r\n' +
                        JSON.stringify(data) +
                        close_delim;

                    const request = gapi.client.request({
                        path: '/upload/drive/v3/files/' + this.fileId,
                        method: 'PATCH',
                        params: { uploadType: 'multipart' },
                        headers: {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        body: multipartRequestBody
                    });

                    await request;
                    return true;
                } catch (error) {
                    console.error('Error uploading file:', error);
                    return false;
                }
            }

            startAutoSync() {
                // Sync every 30 seconds
                this.syncInterval = setInterval(() => {
                    this.syncData();
                }, 30000);
            }

            stopAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }
            }

            updateSyncStatus(state, text) {
                const dot = document.getElementById('syncDot');
                const statusText = document.getElementById('syncText');
                const button = document.getElementById('syncButton');
                const container = document.getElementById('syncStatus');

                if (!dot || !statusText || !button || !container) return;

                dot.className = `sync-dot ${state}`;
                statusText.textContent = text;

                container.classList.remove('syncing', 'error');
                if (state === 'syncing') container.classList.add('syncing');
                if (state === 'error') container.classList.add('error');

                if (state === 'connected') {
                    button.textContent = 'Disconnect';
                    button.onclick = () => this.signOut();
                } else {
                    button.textContent = 'Connect Google Drive';
                    button.onclick = () => this.signIn();
                }
            }

            async uploadPDF(file, quoteReference) {
                if (!this.isSignedIn) {
                    alert('Please connect to Google Drive first');
                    return null;
                }

                try {
                    // Find or create Quote PDFs folder
                    const folderId = await this.getOrCreateQuotePDFsFolder();
                    
                    // Upload the PDF
                    const metadata = {
                        name: `${quoteReference}.pdf`,
                        parents: [folderId]
                    };

                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', file);

                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.auth.getToken().access_token }),
                        body: form
                    });

                    const result = await response.json();
                    return result.id; // Return the Drive file ID
                } catch (error) {
                    console.error('PDF upload error:', error);
                    alert('Failed to upload PDF to Google Drive');
                    return null;
                }
            }

            async getOrCreateQuotePDFsFolder() {
                try {
                    // Search for existing folder
                    const response = await gapi.client.drive.files.list({
                        q: "name='Quote PDFs' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                        fields: 'files(id, name)',
                        spaces: 'drive'
                    });

                    if (response.result.files && response.result.files.length > 0) {
                        return response.result.files[0].id;
                    }

                    // Create folder if it doesn't exist
                    const folderMetadata = {
                        name: 'Quote PDFs',
                        mimeType: 'application/vnd.google-apps.folder'
                    };

                    const folder = await gapi.client.drive.files.create({
                        resource: folderMetadata,
                        fields: 'id'
                    });

                    return folder.result.id;
                } catch (error) {
                    console.error('Folder creation error:', error);
                    throw error;
                }
            }
        }

        // Task storage and management
        class TaskManager {
            constructor() {
                this.tasks = this.loadTasks();
                this.quotes = this.loadQuotes();
                this.efforts = this.loadEfforts();
                this.currentFilter = 'all';
                this.currentQuoteFilter = 'open';
                this.currentEffortFilter = 'active';
                this.currentView = 'list';
                this.currentMonth = new Date();
                this.collapsedSections = this.loadCollapsedSections();
                this.boxOrder = this.loadBoxOrder();
                this.searchQuery = '';
                this.editingEffortId = null;
                this.quickEffortReturnDropdown = null;
                this.init();
            }

            init() {
                this.updateDisplay();
                this.updateDate();
                this.setupEventListeners();
                this.populateEffortDropdowns();
                this.restoreCollapsedSections();
                this.restoreBoxOrder();
                this.setupDragAndDrop();
                this.monthlyClosedClear();
            }

            // Parse YYYY-MM-DD as local time to avoid UTC timezone off-by-one
            parseDate(str) {
                if (!str) return null;
                const [y, m, d] = str.split('-').map(Number);
                return new Date(y, m - 1, d);
            }

            // On the 1st of each month, delete all closed (won/lost) quotes
            monthlyClosedClear() {
                const now = new Date();
                if (now.getDate() !== 1) return;
                const lastClear = localStorage.getItem('lastClosedClear');
                const thisMonth = `${now.getFullYear()}-${now.getMonth() + 1}`;
                if (lastClear === thisMonth) return;
                const before = this.quotes.length;
                this.quotes = this.quotes.filter(q => q.status !== 'closed-won' && q.status !== 'closed-lost');
                if (this.quotes.length < before) {
                    this.saveQuotes();
                    console.log(`Monthly clear: removed ${before - this.quotes.length} closed quotes.`);
                }
                localStorage.setItem('lastClosedClear', thisMonth);
            }

            // Returns a color based on how soon the due date is
            dueDateColor(dueDate) {
                if (!dueDate) return '#6b9e6b'; // dull green for open-ended
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntil <= 3)  return '#dc2626'; // red ‚Äî today or within 3 days
                if (daysUntil <= 7)  return '#c47c1a'; // burnt yellow ‚Äî within a week
                return '#6b9e6b';                       // dull green ‚Äî more than a week away
            }

            setupEventListeners() {
                document.getElementById('addTaskForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTask();
                });

                document.getElementById('quoteForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addQuote();
                });

                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        if (e.target.dataset.filter) {
                            this.setFilter(e.target.dataset.filter);
                        } else if (e.target.dataset.quoteFilter) {
                            this.setQuoteFilter(e.target.dataset.quoteFilter);
                        }
                    });
                });

                document.querySelectorAll('.view-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.setView(e.target.dataset.view);
                    });
                });

                document.getElementById('prevMonth').addEventListener('click', () => {
                    this.currentMonth.setMonth(this.currentMonth.getMonth() - 1);
                    this.renderCalendar();
                });

                document.getElementById('nextMonth').addEventListener('click', () => {
                    this.currentMonth.setMonth(this.currentMonth.getMonth() + 1);
                    this.renderCalendar();
                });

                document.getElementById('todayBtn').addEventListener('click', () => {
                    this.currentMonth = new Date();
                    this.renderCalendar();
                });

                // Set today's date as default for quote form
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('quoteSentDate').value = today;

                // Export quotes button
                document.getElementById('exportQuotesBtn').addEventListener('click', () => {
                    this.exportQuotesToExcel();
                });

                // Close snooze menus when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.btn-snooze') && !e.target.closest('.snooze-menu')) {
                        this.closeAllSnoozeMenus();
                    }
                    if (!e.target.closest('.btn-menu') && !e.target.closest('.dot-menu')) {
                        document.querySelectorAll('.dot-menu.active').forEach(m => m.classList.remove('active'));
                    }
                });

                // Search functionality
                const searchBox = document.getElementById('searchBox');
                const searchToggle = document.getElementById('searchToggle');
                const searchInput = document.getElementById('globalSearch');
                const closeSearch = document.getElementById('closeSearch');

                searchToggle.addEventListener('click', () => {
                    searchBox.classList.add('expanded');
                    searchInput.focus();
                });

                closeSearch.addEventListener('click', () => {
                    searchBox.classList.remove('expanded');
                    searchInput.value = '';
                    this.searchQuery = '';
                    this.updateDisplay();
                });

                searchInput.addEventListener('input', (e) => {
                    this.searchQuery = e.target.value.toLowerCase();
                    this.updateDisplay();
                    // Auto-switch to whichever view has results
                    if (this.searchQuery) {
                        const taskHits = this.tasks.some(t =>
                            !t.completed && (
                                t.title.toLowerCase().includes(this.searchQuery) ||
                                (t.description && t.description.toLowerCase().includes(this.searchQuery)) ||
                                (t.customer && t.customer.toLowerCase().includes(this.searchQuery)) ||
                                (t.poc && t.poc.toLowerCase().includes(this.searchQuery))
                            )
                        );
                        const quoteHits = this.quotes.some(q =>
                            q.reference.toLowerCase().includes(this.searchQuery) ||
                            q.customer.toLowerCase().includes(this.searchQuery) ||
                            (q.notes && q.notes.toLowerCase().includes(this.searchQuery)) ||
                            (q.poc && q.poc.toLowerCase().includes(this.searchQuery))
                        );
                        if (taskHits) this.setView('list');
                        else if (quoteHits) this.setView('quotes');
                    }
                });

                // Close search when clicking outside
                document.addEventListener('click', (e) => {
                    if (!searchBox.contains(e.target) && searchBox.classList.contains('expanded')) {
                        if (!searchInput.value) {
                            searchBox.classList.remove('expanded');
                        }
                    }
                });

                // Prevent search box from closing when clicking inside it
                searchBox.addEventListener('click', (e) => {
                    e.stopPropagation();
                });

                // Export/Import functionality
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });
            }

            setView(view) {
                this.currentView = view;
                document.querySelectorAll('.view-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.view === view);
                });
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                if (view === 'list') {
                    document.getElementById('listView').classList.add('active');
                } else if (view === 'quotes') {
                    document.getElementById('quotesView').classList.add('active');
                    this.renderQuotes();
                } else if (view === 'efforts') {
                    document.getElementById('effortsView').classList.add('active');
                    this.renderEfforts();
                }
            }

            renderCalendar() {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                
                // Update month display
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
                document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;

                // Get first day of month and number of days
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();

                // Get previous month's last days
                const prevMonthLastDay = new Date(year, month, 0).getDate();
                const prevMonthDays = startingDayOfWeek;

                const grid = document.getElementById('calendarGrid');
                grid.innerHTML = '';

                // Day headers
                const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayHeaders.forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'calendar-day-header';
                    header.textContent = day;
                    grid.appendChild(header);
                });

                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                // Previous month days
                for (let i = prevMonthDays - 1; i >= 0; i--) {
                    const day = prevMonthLastDay - i;
                    const date = new Date(year, month - 1, day);
                    this.createCalendarDay(grid, day, date, true);
                }

                // Current month days
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = date.toISOString().split('T')[0];
                    const isToday = dateStr === todayStr;
                    this.createCalendarDay(grid, day, date, false, isToday);
                }

                // Next month days
                const remainingDays = 42 - (prevMonthDays + daysInMonth); // 6 rows * 7 days
                for (let day = 1; day <= remainingDays; day++) {
                    const date = new Date(year, month + 1, day);
                    this.createCalendarDay(grid, day, date, true);
                }
            }

            createCalendarDay(grid, dayNumber, date, otherMonth, isToday = false) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                if (otherMonth) dayDiv.classList.add('other-month');
                if (isToday) dayDiv.classList.add('today');

                const dayNumDiv = document.createElement('div');
                dayNumDiv.className = 'day-number';
                dayNumDiv.textContent = dayNumber;
                dayDiv.appendChild(dayNumDiv);

                // Get tasks for this day
                const dateStr = date.toISOString().split('T')[0];
                const dayTasks = this.tasks.filter(task => 
                    !task.completed && task.dueDate === dateStr
                );

                const todayStr = new Date().toISOString().split('T')[0];
                
                // Show up to 3 tasks, then count
                dayTasks.slice(0, 3).forEach(task => {
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'calendar-task';
                    if (task.dueDate < todayStr) {
                        taskDiv.classList.add('overdue');
                    }
                    taskDiv.textContent = task.title;
                    taskDiv.title = task.title; // Full title on hover
                    dayDiv.appendChild(taskDiv);
                });

                if (dayTasks.length > 3) {
                    const countDiv = document.createElement('div');
                    countDiv.className = 'task-count';
                    countDiv.textContent = `+${dayTasks.length - 3} more`;
                    dayDiv.appendChild(countDiv);
                }

                grid.appendChild(dayDiv);
            }

            // Quote Management Methods
            addQuote() {
                const quoteRef = document.getElementById('quoteRef').value.trim();
                const customerName = document.getElementById('customerName').value.trim();
                const quoteAmount = document.getElementById('quoteAmount').value.trim();
                const quoteNotes = document.getElementById('quoteNotes').value.trim();
                const quoteSentDate = document.getElementById('quoteSentDate').value;
                const reminderInterval = parseInt(document.getElementById('quoteReminderInterval').value);
                const effortId = document.getElementById('quoteEffort').value || null;
                const quoteType = document.getElementById('quoteType').value || 'new';
                const quotePOC = document.getElementById('quotePOC').value.trim();

                if (!quoteRef || !customerName || !quoteSentDate) return;

                const quote = {
                    id: Date.now(),
                    reference: quoteRef,
                    customer: customerName,
                    amount: quoteAmount,
                    notes: quoteNotes,
                    sentDate: quoteSentDate,
                    status: 'active',
                    type: quoteType,
                    poc: quotePOC || null,
                    effortId: effortId ? parseInt(effortId) : null,
                    createdDate: new Date().toISOString(),
                    reminderInterval: reminderInterval,
                    snoozedUntil: null
                };

                this.quotes.push(quote);
                this.saveQuotes();
                this.renderQuotes();

                // Reset form
                document.getElementById('quoteForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('quoteSentDate').value = today;
                document.getElementById('quoteReminderInterval').value = '21';
            }

            snoozeQuote(id, days) {
                const quote = this.quotes.find(q => q.id === id);
                if (quote) {
                    const snoozeDate = new Date();
                    snoozeDate.setDate(snoozeDate.getDate() + days);
                    quote.snoozedUntil = snoozeDate.toISOString();
                    this.saveQuotes();
                    this.renderQuotes();
                }
            }

            closeQuote(id, status, event) {
                const quote = this.quotes.find(q => q.id === id);
                if (quote) {
                    quote.status = status;
                    quote.closedDate = new Date().toISOString();
                    this.saveQuotes();
                    this.renderQuotes();
                    
                    // Trigger confetti if won!
                    if (status === 'closed-won' && event) {
                        this.triggerConfetti(event);
                    }
                }
            }

            triggerConfetti(e) {
                // Get cursor position from the click event
                const x = e ? e.clientX : window.innerWidth / 2;
                const y = e ? e.clientY : window.innerHeight / 2;
                
                // Create 30 confetti pieces
                for (let i = 0; i < 30; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    
                    // Random position around cursor
                    const offsetX = (Math.random() - 0.5) * 100;
                    const offsetY = (Math.random() - 0.5) * 100;
                    
                    confetti.style.left = (x + offsetX) + 'px';
                    confetti.style.top = (y + offsetY) + 'px';
                    
                    // Random size
                    const size = Math.random() * 8 + 5;
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                    
                    // Random shape (circle or square)
                    if (Math.random() > 0.5) {
                        confetti.style.borderRadius = '50%';
                    }
                    
                    document.body.appendChild(confetti);
                    
                    // Remove after animation
                    setTimeout(() => {
                        confetti.remove();
                    }, 2000);
                }
            }

            deleteQuote(id) {
                this.quotes = this.quotes.filter(q => q.id !== id);
                this.saveQuotes();
                this.renderQuotes();
            }

            async attachPDF(quoteId) {
                const quote = this.quotes.find(q => q.id === quoteId);
                if (!quote) return;

                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pdf';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (file.type !== 'application/pdf') {
                        alert('Please select a PDF file');
                        return;
                    }

                    try {
                        const fileId = await window.driveSync.uploadPDF(file, quote.reference);
                        if (fileId) {
                            quote.pdfFileId = fileId;
                            this.saveQuotes();
                            this.renderQuotes();
                            alert('‚úÖ PDF attached successfully!');
                        }
                    } catch (error) {
                        console.error('PDF attach error:', error);
                        alert('Failed to attach PDF');
                    }
                };
                input.click();
            }

            async viewPDF(quoteId) {
                const quote = this.quotes.find(q => q.id === quoteId);
                if (!quote || !quote.pdfFileId) return;

                const modal = document.getElementById('pdfPreviewModal');
                const title = document.getElementById('pdfPreviewTitle');
                const body = document.getElementById('pdfPreviewBody');

                title.textContent = quote.reference;
                body.innerHTML = `<iframe src="https://drive.google.com/file/d/${quote.pdfFileId}/preview"></iframe>`;
                modal.classList.add('open');
            }

            closePDFPreview() {
                const modal = document.getElementById('pdfPreviewModal');
                const body = document.getElementById('pdfPreviewBody');
                modal.classList.remove('open');
                body.innerHTML = '';
            }

            async removePDF(quoteId) {
                const quote = this.quotes.find(q => q.id === quoteId);
                if (!quote || !quote.pdfFileId) return;

                if (confirm('Remove PDF attachment from this quote?')) {
                    quote.pdfFileId = null;
                    this.saveQuotes();
                    this.renderQuotes();
                }
            }

            setQuoteFilter(filter) {
                this.currentQuoteFilter = filter;
                const quotesView = document.getElementById('quotesView');
                quotesView.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.quoteFilter === filter);
                });
                this.renderQuotes();
            }

            getFilteredQuotes() {
                const now = new Date();
                let filteredQuotes = [];
                
                switch (this.currentQuoteFilter) {
                    case 'open':
                        filteredQuotes = this.quotes.filter(q => q.status === 'active');
                        break;
                    case 'follow-up':
                        filteredQuotes = this.quotes.filter(q => {
                            if (q.status !== 'active') return false;
                            if (q.snoozedUntil && new Date(q.snoozedUntil) > now) return false;
                            const reminderDays = q.reminderInterval;
                            if (!reminderDays || reminderDays === 0) return false;
                            const startDate = q.createdDate ? new Date(q.createdDate) : this.parseDate(q.sentDate);
                            const daysSince = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                            return daysSince >= reminderDays;
                        });
                        break;
                    case 'closed':
                        filteredQuotes = this.quotes.filter(q => q.status === 'closed-won' || q.status === 'closed-lost');
                        break;
                    default:
                        filteredQuotes = this.quotes.filter(q => q.status === 'active');
                }

                // Apply search filter
                if (this.searchQuery) {
                    filteredQuotes = filteredQuotes.filter(quote => {
                        return quote.reference.toLowerCase().includes(this.searchQuery) ||
                               quote.customer.toLowerCase().includes(this.searchQuery) ||
                               (quote.notes && quote.notes.toLowerCase().includes(this.searchQuery)) ||
                               (quote.amount && quote.amount.toLowerCase().includes(this.searchQuery)) ||
                               (quote.poc && quote.poc.toLowerCase().includes(this.searchQuery));
                    });
                }

                return filteredQuotes;
            }

            renderQuotes() {
                const quoteList = document.getElementById('quoteList');
                if (!quoteList) return;
                const quotes = this.getFilteredQuotes();
                const now = new Date();

                // Update stats
                const activeQuotes = this.quotes.filter(q => {
                    if (q.status !== 'active') return false;
                    if (q.snoozedUntil && new Date(q.snoozedUntil) > now) return false;
                    return true;
                }).length;
                
                const followUpQuotes = this.quotes.filter(q => {
                    if (q.status !== 'active') return false;
                    if (q.snoozedUntil && new Date(q.snoozedUntil) > now) return false;
                    const reminderDays = q.reminderInterval;
                    if (!reminderDays || reminderDays === 0) return false;
                    const startDate = q.createdDate ? new Date(q.createdDate) : this.parseDate(q.sentDate);
                    const daysSince = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                    return daysSince >= reminderDays;
                }).length;
                
                const totalValue = this.quotes
                    .filter(q => q.status === 'active' && q.amount)
                    .reduce((sum, q) => {
                        const amount = q.amount.replace(/[$,]/g, '');
                        return sum + (parseFloat(amount) || 0);
                    }, 0);

                const thisMonth = now.getMonth();
                const thisYear = now.getFullYear();
                const monthlyWon = this.quotes
                    .filter(q => {
                        if (q.status !== 'closed-won' || !q.closedDate) return false;
                        const closed = new Date(q.closedDate);
                        return closed.getMonth() === thisMonth && closed.getFullYear() === thisYear;
                    })
                    .reduce((sum, q) => {
                        if (!q.amount) return sum;
                        const amount = q.amount.replace(/[$,]/g, '');
                        return sum + (parseFloat(amount) || 0);
                    }, 0);

                document.getElementById('activeQuotes').textContent = activeQuotes;
                document.getElementById('followUpQuotes').textContent = followUpQuotes;
                document.getElementById('totalQuoteValue').textContent = totalValue > 0
                    ? `$${totalValue.toLocaleString()}` 
                    : '$0';
                document.getElementById('monthlyWonValue').textContent = monthlyWon > 0
                    ? `$${monthlyWon.toLocaleString()}`
                    : '$0';

                if (quotes.length === 0) {
                    quoteList.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <h3>No quotes found</h3>
                            <p>Add a new quote to get started</p>
                        </div>
                    `;
                    return;
                }

                // Group quotes by customer
                const groupedByCustomer = quotes.reduce((groups, quote) => {
                    const customer = quote.customer;
                    if (!groups[customer]) {
                        groups[customer] = [];
                    }
                    groups[customer].push(quote);
                    return groups;
                }, {});

                // Sort customers alphabetically
                const sortedCustomers = Object.keys(groupedByCustomer).sort();

                quoteList.innerHTML = sortedCustomers.map(customer => {
                    const customerQuotes = groupedByCustomer[customer];
                    const activeCount = customerQuotes.filter(q => q.status === 'active').length;
                    const totalCustomerValue = customerQuotes
                        .filter(q => q.status === 'active' && q.amount)
                        .reduce((sum, q) => {
                            const amount = q.amount.replace(/[$,]/g, '');
                            return sum + (parseFloat(amount) || 0);
                        }, 0);

                    const quotesHtml = customerQuotes
                        .sort((a, b) => this.parseDate(b.sentDate) - this.parseDate(a.sentDate))
                        .map(quote => {
                            const sentDate = this.parseDate(quote.sentDate);
                            const startDate = quote.createdDate ? new Date(quote.createdDate) : this.parseDate(quote.sentDate);
                            const daysSince = Math.floor((new Date() - startDate) / (1000 * 60 * 60 * 24));
                            const reminderDays = quote.reminderInterval;
                            const needsFollowUp = quote.status === 'active'
                                && reminderDays > 0
                                && daysSince >= reminderDays
                                && !(quote.snoozedUntil && new Date(quote.snoozedUntil) > new Date());

                            let statusBadge = '';
                            if (quote.status === 'active') {
                                statusBadge = '<span class="quote-status active">Active</span>';
                            } else if (quote.status === 'closed-won') {
                                statusBadge = '<span class="quote-status closed-won">Won</span>';
                            } else if (quote.status === 'closed-lost') {
                                statusBadge = '<span class="quote-status closed-lost">Lost</span>';
                            }

                            const quoteType = quote.type || 'new';
                            const typeBadge = quoteType === 'renewal'
                                ? '<span class="quote-type-badge renewal">Renewal</span>'
                                : '<span class="quote-type-badge new">New Business</span>';
                            const typeClass = quoteType === 'renewal' ? 'quote-renewal' : 'quote-new';

                            const followUpAlert = needsFollowUp ? `
                                <div class="follow-up-alert">
                                    ‚ö†Ô∏è Follow-up needed - ${daysSince} days since added (${Math.floor(daysSince / 7)} weeks)
                                </div>
                            ` : '';

                            return `
                                <div class="task-card ${typeClass}" style="margin-left: 0;" onclick="taskManager.toggleTaskExpand(event, 'quote-${quote.id}')">
                                    <div class="task-card-row">
                                        <div class="task-header">
                                            <div class="task-title">${this.escapeHtml(quote.reference)}${quote.pdfFileId ? ' üìé' : ''}</div>
                                            <div class="task-description">${this.escapeHtml(quote.customer)}</div>
                                            <div class="task-meta">
                                                ${typeBadge}
                                                ${quote.status !== 'active' ? statusBadge : ''}
                                                ${quote.amount ? `<div class="meta-item"><span class="meta-label">Amt:</span><span>${this.escapeHtml(quote.amount)}</span></div>` : ''}
                                                <div class="meta-item">
                                                    <span class="meta-label">Sent:</span>
                                                    <span>${sentDate.toLocaleDateString()}</span>
                                                </div>
                                                ${needsFollowUp ? `<span class="badge today">FOLLOW UP</span>` : ''}
                                            </div>
                                        </div>
                                        <div class="task-actions" onclick="event.stopPropagation()">
                                            <div style="position: relative; display: inline-block;">
                                                <button class="btn-snooze" onclick="taskManager.toggleSnoozeMenu('quote-${quote.id}', event)">‚è∞</button>
                                                <div id="snooze-menu-quote-${quote.id}" class="snooze-menu">
                                                    <button class="snooze-option" onclick="taskManager.snoozeQuote(${quote.id}, 1); taskManager.closeAllSnoozeMenus();">1 day</button>
                                                    <button class="snooze-option" onclick="taskManager.snoozeQuote(${quote.id}, 3); taskManager.closeAllSnoozeMenus();">3 days</button>
                                                    <button class="snooze-option" onclick="taskManager.snoozeQuote(${quote.id}, 7); taskManager.closeAllSnoozeMenus();">1 week</button>
                                                    <button class="snooze-option" onclick="taskManager.snoozeQuote(${quote.id}, 14); taskManager.closeAllSnoozeMenus();">2 weeks</button>
                                                </div>
                                            </div>
                                            <div style="position: relative; display: inline-block;">
                                                <button class="btn-menu" onclick="taskManager.toggleDotMenu('quote-dot-${quote.id}', event)">‚Ä¢‚Ä¢‚Ä¢</button>
                                                <div id="quote-dot-${quote.id}" class="dot-menu">
                                                    <button class="dot-menu-item" onclick="taskManager.openEditQuote(${quote.id})">Edit Quote</button>
                                                    <button class="dot-menu-item" onclick="taskManager.attachPDF(${quote.id})">üìé Attach PDF</button>
                                                    ${quote.pdfFileId ? `<button class="dot-menu-item" onclick="taskManager.viewPDF(${quote.id})">üëÅÔ∏è View PDF</button>` : ''}
                                                    ${quote.pdfFileId ? `<button class="dot-menu-item" onclick="taskManager.removePDF(${quote.id})">üóëÔ∏è Remove PDF</button>` : ''}
                                                </div>
                                            </div>
                                            <button class="btn-delete" onclick="taskManager.deleteQuote(${quote.id})">‚úï</button>
                                        </div>
                                    </div>
                                    <div class="task-card-expanded">
                                        <div class="expanded-grid">
                                            <div>
                                                <div class="expanded-label">Reference</div>
                                                <div class="expanded-value">${this.escapeHtml(quote.reference)}</div>
                                            </div>
                                            <div>
                                                <div class="expanded-label">Customer</div>
                                                <div class="expanded-value">${this.escapeHtml(quote.customer)}</div>
                                            </div>
                                            ${quote.poc ? `<div>
                                                <div class="expanded-label">Point of Contact</div>
                                                <div class="expanded-value">${this.escapeHtml(quote.poc)}</div>
                                            </div>` : ''}
                                            <div>
                                                <div class="expanded-label">Amount</div>
                                                <div class="expanded-value">${quote.amount ? this.escapeHtml(quote.amount) : 'N/A'}</div>
                                            </div>
                                            <div>
                                                <div class="expanded-label">Status</div>
                                                <div class="expanded-value">${quote.status === 'active' ? 'Active' : statusBadge}</div>
                                            </div>
                                            <div>
                                                <div class="expanded-label">Type</div>
                                                <div class="expanded-value">${typeBadge}</div>
                                            </div>
                                            <div>
                                                <div class="expanded-label">Date Sent</div>
                                                <div class="expanded-value">${sentDate.toLocaleDateString()}</div>
                                            </div>
                                            <div>
                                                <div class="expanded-label">Days Open</div>
                                                <div class="expanded-value">${Math.floor((new Date() - sentDate) / (1000 * 60 * 60 * 24))} days</div>
                                            </div>
                                            <div>
                                                <div class="expanded-label">Follow-up Reminder</div>
                                                <div class="expanded-value">${reminderDays > 0 ? 'Every ' + reminderDays + ' days' : 'None'}</div>
                                            </div>
                                            ${quote.closedDate ? `
                                            <div>
                                                <div class="expanded-label">Closed Date</div>
                                                <div class="expanded-value">${this.parseDate(quote.closedDate).toLocaleDateString()}</div>
                                            </div>` : ''}
                                            ${quote.notes ? `
                                            <div style="grid-column: 1 / -1;">
                                                <div class="expanded-label">Notes</div>
                                                <div class="expanded-value">${this.escapeHtml(quote.notes)}</div>
                                            </div>` : ''}
                                        </div>
                                        ${followUpAlert}
                                        ${quote.status === 'active' ? `
                                        <div style="display:flex; gap:8px; margin-top:12px;" onclick="event.stopPropagation()">
                                            <button class="btn-won" onclick="taskManager.closeQuote(${quote.id}, 'closed-won', event)">Mark as Won</button>
                                            <button class="btn-lost" onclick="taskManager.closeQuote(${quote.id}, 'closed-lost')">Mark as Lost</button>
                                        </div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');

                    return `
                        <div class="customer-group">
                            <div class="customer-header">
                                <div class="customer-name">${this.escapeHtml(customer)}</div>
                                <div class="customer-stats">
                                    <div class="customer-stat">
                                        <strong>${activeCount}</strong> active quote${activeCount !== 1 ? 's' : ''}
                                    </div>
                                    ${totalCustomerValue > 0 ? `
                                        <div class="customer-stat">
                                            <strong>$${totalCustomerValue.toLocaleString()}</strong> total value
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            ${quotesHtml}
                        </div>
                    `;
                }).join('');
            }

            loadQuotes() {
                const saved = localStorage.getItem('salesQuotes');
                return saved ? JSON.parse(saved) : [];
            }

            saveQuotes() {
                localStorage.setItem('salesQuotes', JSON.stringify(this.quotes));
            }

            exportQuotesToExcel() {
                // Prepare data for export
                const exportData = this.quotes.map(quote => {
                    const sentDate = this.parseDate(quote.sentDate);
                    const daysSince = Math.floor((new Date() - sentDate) / (1000 * 60 * 60 * 24));
                    const weeksSince = Math.floor(daysSince / 7);
                    
                    let statusText = 'Active';
                    if (quote.status === 'closed-won') statusText = 'Won';
                    if (quote.status === 'closed-lost') statusText = 'Lost';

                    return {
                        'Quote Reference': quote.reference,
                        'Customer': quote.customer,
                        'Amount': quote.amount || '',
                        'Status': statusText,
                        'Date Sent': sentDate.toLocaleDateString(),
                        'Days Open': daysSince,
                        'Weeks Open': weeksSince,
                        'Follow Up': (quote.status === 'active' && daysSince >= 21) ? 'YES' : 'NO',
                        'Closed Date': quote.closedDate ? this.parseDate(quote.closedDate).toLocaleDateString() : '',
                        'Notes': quote.notes || ''
                    };
                });

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Set column widths
                const colWidths = [
                    { wch: 16 }, // Quote Reference
                    { wch: 25 }, // Customer
                    { wch: 12 }, // Amount
                    { wch: 10 }, // Status
                    { wch: 12 }, // Date Sent
                    { wch: 10 }, // Days Open
                    { wch: 11 }, // Weeks Open
                    { wch: 15 }, // Follow Up
                    { wch: 12 }, // Closed Date
                    { wch: 40 }  // Notes
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Quotes');

                // Generate filename with current date
                const today = new Date();
                const filename = `Quote_Tracker_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}.xlsx`;

                // Download file
                XLSX.writeFile(wb, filename);
            }

            addTask() {
                const title = document.getElementById('taskTitle').value.trim();
                const description = document.getElementById('taskDescription').value.trim();
                const dueDate = document.getElementById('taskDueDate').value;
                const effortId = document.getElementById('taskEffort').value || null;
                const poc = document.getElementById('taskPOC').value.trim();
                const customer = document.getElementById('taskCustomer').value.trim();

                if (!title) return;

                const task = {
                    id: Date.now(),
                    title,
                    description,
                    dueDate: dueDate || null,
                    effortId: effortId ? parseInt(effortId) : null,
                    poc: poc || null,
                    customer: customer || null,
                    createdDate: new Date().toISOString(),
                    completed: false,
                    snoozedUntil: null
                };

                this.tasks.push(task);
                this.saveTasks();
                this.updateDisplay();

                // Reset form
                document.getElementById('addTaskForm').reset();
            }

            snoozeTask(id, days) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    const snoozeDate = new Date();
                    snoozeDate.setDate(snoozeDate.getDate() + days);
                    task.snoozedUntil = snoozeDate.toISOString();
                    this.saveTasks();
                    this.updateDisplay();
                }
            }

            deleteTask(id) {
                this.tasks = this.tasks.filter(task => task.id !== id);
                this.saveTasks();
                this.updateDisplay();
            }

            completeTask(id) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    task.completed = true;
                    task.completedDate = new Date().toISOString();
                    this.saveTasks();
                    this.updateDisplay();
                }
            }

            setFilter(filter) {
                this.currentFilter = filter;
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.filter === filter);
                });
                this.updateDisplay();
            }

            getFilteredTasks() {
                const today = new Date().toISOString().split('T')[0];
                const now = new Date();
                let activeTasks = this.tasks.filter(task => {
                    if (task.completed) return false;
                    if (this.currentFilter !== 'all' && task.snoozedUntil && new Date(task.snoozedUntil) > now) return false;
                    return true;
                });

                // Apply search filter
                if (this.searchQuery) {
                    activeTasks = activeTasks.filter(task => {
                        return task.title.toLowerCase().includes(this.searchQuery) ||
                               (task.description && task.description.toLowerCase().includes(this.searchQuery)) ||
                               (task.customer && task.customer.toLowerCase().includes(this.searchQuery)) ||
                               (task.poc && task.poc.toLowerCase().includes(this.searchQuery));
                    });
                }

                switch (this.currentFilter) {
                    case 'today':
                        return activeTasks.filter(task => task.dueDate && task.dueDate <= today);
                    case 'overdue':
                        return activeTasks.filter(task => task.dueDate && task.dueDate < today);
                    case 'open-ended':
                        return activeTasks.filter(task => !task.dueDate);
                    default:
                        return activeTasks;
                }
            }

            updateDisplay() {
                if (this.currentView === 'quotes') {
                    this.renderQuotes();
                } else {
                    this.renderTasks();
                }
                this.updateStats();
            }

            renderTasks() {
                const taskList = document.getElementById('taskList');
                if (!taskList) return;
                const tasks = this.getFilteredTasks();

                if (tasks.length === 0) {
                    taskList.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                            </svg>
                            <h3>No tasks found</h3>
                            <p>Add a new task to get started</p>
                        </div>
                    `;
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                
                taskList.innerHTML = tasks
                    .sort((a, b) => {
                        // Sort: overdue first, then due today, then by due date, then open-ended
                        if (a.dueDate && b.dueDate) {
                            return this.parseDate(a.dueDate) - this.parseDate(b.dueDate);
                        }
                        if (a.dueDate && !b.dueDate) return -1;
                        if (!a.dueDate && b.dueDate) return 1;
                        return 0;
                    })
                    .map(task => {
                        const isOverdue = task.dueDate && task.dueDate < today;
                        const isDueToday = task.dueDate === today;
                        
                        const createdDate = new Date(task.createdDate);
                        const dueDate = task.dueDate ? this.parseDate(task.dueDate) : null;
                        
                        const isSnoozed = task.snoozedUntil && new Date(task.snoozedUntil) > new Date();
                        const cardClass = !isSnoozed && isOverdue ? 'overdue' : !isSnoozed && isDueToday ? 'due-today' : '';
                        const badgeHtml = isSnoozed
                            ? '<span class="badge snoozed">SNOOZED</span>'
                            : isOverdue 
                                ? '<span class="badge overdue">OVERDUE</span>'
                                : isDueToday 
                                    ? '<span class="badge today">DUE TODAY</span>'
                                    : '';

                        const displayDueDate = isSnoozed
                            ? new Date(task.snoozedUntil).toLocaleDateString()
                            : dueDate ? dueDate.toLocaleDateString() : null;
                        const dueDateColor = isSnoozed ? 'var(--text-primary)' : this.dueDateColor(dueDate);

                        return `
                            <div class="task-card ${cardClass}" onclick="taskManager.toggleTaskExpand(event, ${task.id})">
                                <div class="task-card-row">
                                    <div class="task-header">
                                        <div class="task-title">${this.escapeHtml(task.title)}</div>
                                        ${task.description ? `<div class="task-description">${this.escapeHtml(task.description)}</div>` : '<div class="task-description"></div>'}
                                        <div class="task-meta">
                                            ${badgeHtml ? `<span>${badgeHtml}</span>` : ''}
                                            ${task.customer ? `<div class="meta-item" style="color:var(--text-secondary); font-size:0.85rem;">${this.escapeHtml(task.customer)}</div>` : ''}
                                            <div class="meta-item">
                                                <span class="meta-label">Due:</span>
                                                <strong style="color:${dueDateColor}">${displayDueDate || 'Open-ended'}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="task-actions" onclick="event.stopPropagation()">
                                        <div style="position: relative; display: inline-block;">
                                            <button class="btn-menu" onclick="taskManager.toggleDotMenu('task-dot-${task.id}', event)">‚Ä¢‚Ä¢‚Ä¢</button>
                                            <div id="task-dot-${task.id}" class="dot-menu">
                                                <button class="dot-menu-item" onclick="taskManager.completeTask(${task.id})">Complete</button>
                                                <button class="dot-menu-item" onclick="taskManager.openEditTask(${task.id})">Edit Task</button>
                                                <button class="dot-menu-item" style="color:#dc2626;" onclick="taskManager.deleteTask(${task.id})">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="task-card-expanded">
                                    <div class="expanded-grid">
                                        <div>
                                            <div class="expanded-label">Title</div>
                                            <div class="expanded-value">${this.escapeHtml(task.title)}</div>
                                        </div>
                                        ${task.description ? `
                                        <div>
                                            <div class="expanded-label">Description</div>
                                            <div class="expanded-value">${this.escapeHtml(task.description)}</div>
                                        </div>` : ''}
                                        <div>
                                            <div class="expanded-label">Date Added</div>
                                            <div class="expanded-value">${createdDate.toLocaleDateString()}</div>
                                        </div>
                                        ${task.customer ? `<div>
                                            <div class="expanded-label">Customer</div>
                                            <div class="expanded-value">${this.escapeHtml(task.customer)}</div>
                                        </div>` : ''}
                                        <div>
                                            <div class="expanded-label">Due Date</div>
                                            <div class="expanded-value"><strong style="color:${this.dueDateColor(dueDate)}">${dueDate ? dueDate.toLocaleDateString() : 'Open-ended'}</strong></div>
                                        </div>
                                        ${isSnoozed ? `<div>
                                            <div class="expanded-label">Snoozed Until</div>
                                            <div class="expanded-value" style="color:#64748b;">${new Date(task.snoozedUntil).toLocaleDateString()}</div>
                                        </div>` : ''}
                                        <div>
                                            <div class="expanded-label">Status</div>
                                            <div class="expanded-value">${badgeHtml || '<span style="color: var(--accent)">On Track</span>'}</div>
                                        </div>
                                        ${task.poc ? `<div>
                                            <div class="expanded-label">Point of Contact</div>
                                            <div class="expanded-value">${this.escapeHtml(task.poc)}</div>
                                        </div>` : ''}
                                    </div>
                                    <div style="display:flex; align-items:center; gap:6px; margin-top:14px; padding-top:12px; border-top:1px solid var(--border);" onclick="event.stopPropagation()">
                                        <span style="font-size:0.75rem; color:var(--text-secondary); font-family:'JetBrains Mono',monospace; flex-shrink:0;">Snooze:</span>
                                        <button class="snooze-option" onclick="taskManager.snoozeTask(${task.id}, 1); taskManager.updateDisplay();">1 day</button>
                                        <button class="snooze-option" onclick="taskManager.snoozeTask(${task.id}, 3); taskManager.updateDisplay();">3 days</button>
                                        <button class="snooze-option" onclick="taskManager.snoozeTask(${task.id}, 7); taskManager.updateDisplay();">1 week</button>
                                        <button class="snooze-option" onclick="taskManager.snoozeTask(${task.id}, 14); taskManager.updateDisplay();">2 weeks</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    })
                    .join('');
            }

            toggleTaskExpand(event, id) {
                // Don't expand if clicking buttons
                if (event.target.closest('.task-actions')) return;
                const card = event.currentTarget;
                card.classList.toggle('expanded');
            }

            toggleDotMenu(menuId, event) {
                event.stopPropagation();
                // Close all other dot menus first
                document.querySelectorAll('.dot-menu.active').forEach(m => {
                    if (m.id !== menuId) m.classList.remove('active');
                });
                const menu = document.getElementById(menuId);
                if (!menu) return;

                // Position the menu relative to the button using fixed coordinates
                const btn = event.currentTarget;
                const rect = btn.getBoundingClientRect();
                menu.style.top = (rect.bottom + 4) + 'px';
                menu.style.left = (rect.left - menu.offsetWidth + btn.offsetWidth) + 'px';
                menu.classList.toggle('active');

                // Adjust if off screen
                setTimeout(() => {
                    const menuRect = menu.getBoundingClientRect();
                    if (menuRect.right > window.innerWidth) {
                        menu.style.left = (window.innerWidth - menuRect.width - 10) + 'px';
                    }
                    if (menuRect.bottom > window.innerHeight) {
                        menu.style.top = (rect.top - menuRect.height - 4) + 'px';
                    }
                }, 0);
            }

            openEditTask(id) {
                document.querySelectorAll('.dot-menu.active').forEach(m => m.classList.remove('active'));
                const task = this.tasks.find(t => t.id === id);
                if (!task) return;

                this.editingTaskId = id;
                document.getElementById('editTaskTitle').value = task.title || '';
                document.getElementById('editTaskCustomer').value = task.customer || '';
                document.getElementById('editTaskDescription').value = task.description || '';
                document.getElementById('editTaskDueDate').value = task.dueDate || '';
                document.getElementById('editTaskPOC').value = task.poc || '';
                this.populateEffortDropdowns();
                document.getElementById('editTaskEffort').value = task.effortId || '';
                document.getElementById('editTaskModal').classList.remove('hidden');
            }

            closeEditModal() {
                document.getElementById('editTaskModal').classList.add('hidden');
                this.editingTaskId = null;
            }

            saveEditTask() {
                const task = this.tasks.find(t => t.id === this.editingTaskId);
                if (!task) return;

                task.title = document.getElementById('editTaskTitle').value.trim();
                task.customer = document.getElementById('editTaskCustomer').value.trim() || null;
                task.description = document.getElementById('editTaskDescription').value.trim();
                task.dueDate = document.getElementById('editTaskDueDate').value || null;
                task.poc = document.getElementById('editTaskPOC').value.trim() || null;
                const effortVal = document.getElementById('editTaskEffort').value;
                task.effortId = effortVal ? parseInt(effortVal) : null;

                this.saveTasks();
                this.updateDisplay();
                this.closeEditModal();
            }

            openEditQuote(id) {
                document.querySelectorAll('.dot-menu.active').forEach(m => m.classList.remove('active'));
                const quote = this.quotes.find(q => q.id === id);
                if (!quote) return;

                this.editingQuoteId = id;
                document.getElementById('editQuoteReference').value = quote.reference || '';
                document.getElementById('editQuoteCustomer').value = quote.customer || '';
                document.getElementById('editQuoteAmount').value = quote.amount || '';
                document.getElementById('editQuoteSentDate').value = quote.sentDate || '';
                document.getElementById('editQuoteNotes').value = quote.notes || '';
                document.getElementById('editQuotePOC').value = quote.poc || '';
                document.getElementById('editQuoteType').value = quote.type || 'new';
                document.getElementById('editQuoteReminderInterval').value = quote.reminderInterval ?? 21;
                this.populateEffortDropdowns();
                document.getElementById('editQuoteEffort').value = quote.effortId || '';
                document.getElementById('editQuoteModal').classList.remove('hidden');
            }

            closeEditQuoteModal() {
                document.getElementById('editQuoteModal').classList.add('hidden');
                this.editingQuoteId = null;
            }

            saveEditQuote() {
                const quote = this.quotes.find(q => q.id === this.editingQuoteId);
                if (!quote) return;

                quote.reference = document.getElementById('editQuoteReference').value.trim();
                quote.customer = document.getElementById('editQuoteCustomer').value.trim();
                quote.amount = document.getElementById('editQuoteAmount').value.trim();
                quote.sentDate = document.getElementById('editQuoteSentDate').value;
                quote.notes = document.getElementById('editQuoteNotes').value.trim();
                quote.poc = document.getElementById('editQuotePOC').value.trim() || null;
                quote.type = document.getElementById('editQuoteType').value || 'new';
                quote.reminderInterval = parseInt(document.getElementById('editQuoteReminderInterval').value);
                quote.effortId = document.getElementById('editQuoteEffort').value || null;

                this.saveQuotes();
                this.renderQuotes();
                this.closeEditQuoteModal();
            }

            // ‚îÄ‚îÄ EFFORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            loadEfforts() {
                const saved = localStorage.getItem('efforts');
                return saved ? JSON.parse(saved) : [];
            }

            saveEfforts() {
                localStorage.setItem('efforts', JSON.stringify(this.efforts));
            }

            populateEffortDropdowns() {
                const dropdowns = ['taskEffort', 'quoteEffort', 'editTaskEffort', 'editQuoteEffort'];
                dropdowns.forEach(id => {
                    const sel = document.getElementById(id);
                    if (!sel) return;
                    const current = sel.value;
                    sel.innerHTML = '<option value="">‚Äî No effort ‚Äî</option>';
                    sel.innerHTML += '<option value="__new__">Ôºã Create new effort...</option>';
                    this.efforts
                        .filter(e => e.status === 'active')
                        .forEach(e => {
                            const opt = document.createElement('option');
                            opt.value = e.id;
                            opt.textContent = e.name;
                            sel.appendChild(opt);
                        });
                    sel.value = current;

                    // Remove old listener and add fresh one
                    sel.onchange = (e) => {
                        if (e.target.value === '__new__') {
                            e.target.value = '';
                            this.openQuickNewEffort(id);
                        }
                    };
                });
            }

            openQuickNewEffort(returnDropdownId) {
                this.quickEffortReturnDropdown = returnDropdownId;
                this.editingEffortId = null;
                document.getElementById('effortModalTitle').textContent = 'New Effort';
                document.getElementById('effortName').value = '';
                document.getElementById('effortCustomer').value = '';
                document.getElementById('effortStatus').value = 'active';
                document.getElementById('effortNotes').value = '';
                document.getElementById('effortHighPriority').checked = false;
                document.getElementById('effortModal').classList.remove('hidden');
            }

            openNewEffortModal() {
                this.editingEffortId = null;
                document.getElementById('effortModalTitle').textContent = 'New Effort';
                document.getElementById('effortName').value = '';
                document.getElementById('effortCustomer').value = '';
                document.getElementById('effortStatus').value = 'active';
                document.getElementById('effortNotes').value = '';
                document.getElementById('effortHighPriority').checked = false;
                document.getElementById('effortModal').classList.remove('hidden');
            }

            openEditEffort(id) {
                document.querySelectorAll('.dot-menu.active').forEach(m => m.classList.remove('active'));
                const effort = this.efforts.find(e => e.id === id);
                if (!effort) return;
                this.editingEffortId = id;
                document.getElementById('effortModalTitle').textContent = 'Edit Effort';
                document.getElementById('effortName').value = effort.name || '';
                document.getElementById('effortCustomer').value = effort.customer || '';
                document.getElementById('effortStatus').value = effort.status || 'active';
                document.getElementById('effortNotes').value = effort.notes || '';
                document.getElementById('effortHighPriority').checked = !!effort.highPriority;
                document.getElementById('effortModal').classList.remove('hidden');
            }

            closeEffortModal() {
                document.getElementById('effortModal').classList.add('hidden');
                this.editingEffortId = null;
            }

            saveEffort() {
                const name = document.getElementById('effortName').value.trim();
                if (!name) return;

                let newId = null;

                if (this.editingEffortId) {
                    const effort = this.efforts.find(e => e.id === this.editingEffortId);
                    if (effort) {
                        effort.name = name;
                        effort.customer = document.getElementById('effortCustomer').value.trim();
                        effort.status = document.getElementById('effortStatus').value;
                        effort.notes = document.getElementById('effortNotes').value.trim();
                        effort.highPriority = document.getElementById('effortHighPriority').checked;
                    }
                } else {
                    newId = Date.now();
                    this.efforts.push({
                        id: newId,
                        name,
                        customer: document.getElementById('effortCustomer').value.trim(),
                        status: document.getElementById('effortStatus').value,
                        notes: document.getElementById('effortNotes').value.trim(),
                        highPriority: document.getElementById('effortHighPriority').checked,
                        createdDate: new Date().toISOString()
                    });
                }

                this.saveEfforts();
                this.populateEffortDropdowns();
                this.renderEfforts();
                this.closeEffortModal();

                // Auto-select the new effort in the dropdown it was triggered from
                if (newId && this.quickEffortReturnDropdown) {
                    const sel = document.getElementById(this.quickEffortReturnDropdown);
                    if (sel) sel.value = newId;
                    this.quickEffortReturnDropdown = null;
                }
            }

            deleteEffort(id) {
                if (!confirm('Delete this effort? Linked tasks and quotes will not be deleted.')) return;
                this.efforts = this.efforts.filter(e => e.id !== id);
                this.saveEfforts();
                this.populateEffortDropdowns();
                this.renderEfforts();
            }

            renderEfforts() {
                // Filter efforts
                let filtered = this.efforts;
                if (this.currentEffortFilter !== 'all') {
                    filtered = this.efforts.filter(e => e.status === this.currentEffortFilter);
                }

                const container = document.getElementById('effortList');
                if (!filtered.length) {
                    container.innerHTML = '<div style="color: var(--text-secondary); padding: 20px 0; text-align: center; font-size: 0.9rem;">No efforts yet. Click "+ New Effort" to get started.</div>';
                    return;
                }

                container.innerHTML = filtered.map(effort => {
                    const linkedTasks = this.tasks.filter(t => t.effortId == effort.id && !t.completed);
                    const linkedQuotes = this.quotes.filter(q => q.effortId == effort.id);

                    const tasksHtml = linkedTasks.length
                        ? linkedTasks.map(t => `
                            <div class="effort-linked-item" onclick="event.stopPropagation(); taskManager.goToTask(${t.id})">
                                <span style="color: var(--accent);">‚úì</span>
                                <span class="item-label">${this.escapeHtml(t.title)}</span>
                                <span class="item-meta">${t.dueDate ? 'Due ' + this.parseDate(t.dueDate).toLocaleDateString() : 'Open-ended'}</span>
                            </div>`).join('')
                        : '<div class="effort-empty">No tasks linked</div>';

                    const quotesHtml = linkedQuotes.length
                        ? linkedQuotes.map(q => `
                            <div class="effort-linked-item" onclick="event.stopPropagation(); taskManager.goToQuote(${q.id})">
                                <span style="color: var(--accent);">üìÑ</span>
                                <span class="item-label">${this.escapeHtml(q.reference)}</span>
                                <span class="item-meta">${q.amount ? this.escapeHtml(q.amount) + ' ¬∑ ' : ''}${q.status === 'active' ? 'Active' : q.status === 'closed-won' ? 'Won' : 'Lost'}</span>
                            </div>`).join('')
                        : '<div class="effort-empty">No quotes linked</div>';

                    const statusClass = effort.status;
                    const statusLabel = effort.status.charAt(0).toUpperCase() + effort.status.slice(1);
                    const priorityClass = effort.highPriority ? 'high-priority' : '';
                    const priorityBadge = effort.highPriority
                        ? '<span class="effort-priority-badge">High Priority</span>'
                        : '';

                    return `
                        <div class="effort-card ${priorityClass}" onclick="taskManager.toggleEffortExpand(event, ${effort.id})">
                            <div class="effort-card-row">
                                <div class="effort-name">${this.escapeHtml(effort.name)}</div>
                                <div class="effort-customer">${this.escapeHtml(effort.customer || '')}</div>
                                <div class="effort-meta">
                                    <span style="width:120px; flex-shrink:0;">${priorityBadge}</span>
                                    <span class="meta-item" style="width:60px; flex-shrink:0;"><span class="meta-label">Tasks:</span> ${linkedTasks.length}</span>
                                    <span class="meta-item" style="width:70px; flex-shrink:0;"><span class="meta-label">Quotes:</span> ${linkedQuotes.length}</span>
                                    ${effort.status !== 'active' ? `<span class="effort-status ${statusClass}">${statusLabel}</span>` : ''}
                                </div>
                                <div class="effort-actions" onclick="event.stopPropagation()">
                                    <div style="position: relative; display: inline-block;">
                                        <button class="btn-menu" onclick="taskManager.toggleDotMenu('effort-dot-${effort.id}', event)">‚Ä¢‚Ä¢‚Ä¢</button>
                                        <div id="effort-dot-${effort.id}" class="dot-menu">
                                            <button class="dot-menu-item" onclick="taskManager.openEditEffort(${effort.id})">‚úèÔ∏è Edit Effort</button>
                                        </div>
                                    </div>
                                    <button class="btn-delete" onclick="taskManager.deleteEffort(${effort.id})">‚úï</button>
                                </div>
                            </div>
                            <div class="effort-expanded">
                                ${effort.notes ? `
                                    <div class="effort-section-label">Notes</div>
                                    <div class="effort-notes-text">${this.escapeHtml(effort.notes)}</div>
                                ` : ''}
                                <div class="effort-section-label">Linked Tasks</div>
                                ${tasksHtml}
                                <div class="effort-section-label">Linked Quotes</div>
                                ${quotesHtml}
                            </div>
                        </div>
                    `;
                }).join('');

                // Effort filter tabs
                document.querySelectorAll('[data-effort-filter]').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.effortFilter === this.currentEffortFilter);
                    tab.onclick = () => {
                        this.currentEffortFilter = tab.dataset.effortFilter;
                        this.renderEfforts();
                    };
                });
            }

            toggleEffortExpand(event, id) {
                if (event.target.closest('.effort-actions')) return;
                event.currentTarget.classList.toggle('expanded');
            }

            toggleSnoozeMenu(id, event) {
                event.stopPropagation();
                this.closeAllSnoozeMenus();
                const menu = document.getElementById(`snooze-menu-${id}`);
                if (menu) {
                    menu.classList.add('active');
                }
            }

            closeAllSnoozeMenus() {
                document.querySelectorAll('.snooze-menu').forEach(menu => {
                    menu.classList.remove('active');
                });
            }

            closeAllDotMenus() {
                document.querySelectorAll('.dot-menu').forEach(menu => {
                    menu.classList.remove('active');
                });
            }

            toggleSection(section) {
                const contentId = section + 'Content';
                const buttonId = 'toggle' + section.charAt(0).toUpperCase() + section.slice(1);
                const content = document.getElementById(contentId);
                const button = document.getElementById(buttonId);
                
                if (!content || !button) return;

                const isCollapsed = content.classList.contains('collapsed');
                const parentBox = content.closest('.draggable-box');
                
                if (isCollapsed) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    setTimeout(() => {
                        content.classList.remove('collapsed');
                        content.style.maxHeight = 'none';
                    }, 10);
                    button.textContent = '‚àí';
                    if (parentBox) parentBox.classList.remove('has-collapsed-content');
                    this.collapsedSections[section] = false;
                } else {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    setTimeout(() => {
                        content.style.maxHeight = '0';
                        content.classList.add('collapsed');
                    }, 10);
                    button.textContent = '+';
                    if (parentBox) parentBox.classList.add('has-collapsed-content');
                    this.collapsedSections[section] = true;
                }
                
                this.saveCollapsedSections();
            }

            restoreCollapsedSections() {
                Object.keys(this.collapsedSections).forEach(section => {
                    if (this.collapsedSections[section]) {
                        const contentId = section + 'Content';
                        const buttonId = 'toggle' + section.charAt(0).toUpperCase() + section.slice(1);
                        const content = document.getElementById(contentId);
                        const button = document.getElementById(buttonId);
                        
                        if (content && button) {
                            content.classList.add('collapsed');
                            content.style.maxHeight = '0';
                            button.textContent = '+';
                            const parentBox = content.closest('.draggable-box');
                            if (parentBox) parentBox.classList.add('has-collapsed-content');
                        }
                    }
                });
            }

            loadCollapsedSections() {
                const saved = localStorage.getItem('collapsedSections');
                return saved ? JSON.parse(saved) : {};
            }

            saveCollapsedSections() {
                localStorage.setItem('collapsedSections', JSON.stringify(this.collapsedSections));
            }

            setupDragAndDrop() {
                const container = document.getElementById('draggableContainer');
                const draggables = document.querySelectorAll('.draggable-box');
                
                let draggedElement = null;

                draggables.forEach(draggable => {
                    const header = draggable.querySelector('.section-header');
                    
                    // Make only the header draggable, not the whole box
                    header.addEventListener('mousedown', (e) => {
                        // Don't start drag if clicking on the minimize button
                        if (e.target.closest('.minimize-btn')) {
                            return;
                        }
                        draggable.setAttribute('draggable', 'true');
                    });

                    draggable.addEventListener('dragstart', (e) => {
                        draggedElement = draggable;
                        draggable.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                    });

                    draggable.addEventListener('dragend', () => {
                        draggable.classList.remove('dragging');
                        draggable.setAttribute('draggable', 'false');
                        this.saveBoxOrder();
                    });
                });

                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!draggedElement) return;
                    
                    const afterElement = this.getDragAfterElement(container, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(draggedElement);
                    } else {
                        container.insertBefore(draggedElement, afterElement);
                    }
                });
            }

            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.draggable-box:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;

                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            loadBoxOrder() {
                const saved = localStorage.getItem('boxOrder');
                return saved ? JSON.parse(saved) : ['taskForm', 'quoteForm'];
            }

            saveBoxOrder() {
                const container = document.getElementById('draggableContainer');
                const boxes = container.querySelectorAll('.draggable-box');
                const order = Array.from(boxes).map(box => box.dataset.boxId);
                localStorage.setItem('boxOrder', JSON.stringify(order));
            }

            restoreBoxOrder() {
                const container = document.getElementById('draggableContainer');
                const boxes = {};
                
                container.querySelectorAll('.draggable-box').forEach(box => {
                    boxes[box.dataset.boxId] = box;
                });

                this.boxOrder.forEach(boxId => {
                    if (boxes[boxId]) {
                        container.appendChild(boxes[boxId]);
                    }
                });
            }

            goToDueToday() {
                this.setView('list');
                this.setFilter('today');
                setTimeout(() => {
                    const taskList = document.getElementById('listView');
                    if (taskList) {
                        taskList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }

            goToAllTasks() {
                this.setView('list');
                this.setFilter('all');
                setTimeout(() => {
                    const listView = document.getElementById('listView');
                    if (listView) listView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }

            openBriefing(type) {
                const panel = document.getElementById('briefingPanel');
                const overlay = document.getElementById('briefingOverlay');
                const title = document.getElementById('briefingTitle');
                const subtitle = document.getElementById('briefingSubtitle');
                const body = document.getElementById('briefingBody');

                const now = new Date();
                const todayStr = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                const todayKey = now.toISOString().split('T')[0];
                const tomorrowKey = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString().split('T')[0];
                const in3Days = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 3).toISOString().split('T')[0];

                if (type === 'morning') {
                    title.textContent = 'Morning Briefing';
                    subtitle.textContent = todayStr;

                    const overdue = this.tasks.filter(t => !t.completed && t.dueDate && t.dueDate < todayKey && !(t.snoozedUntil && new Date(t.snoozedUntil) > now));
                    const dueToday = this.tasks.filter(t => !t.completed && t.dueDate === todayKey && !(t.snoozedUntil && new Date(t.snoozedUntil) > now));
                    const upcoming = this.tasks.filter(t => !t.completed && t.dueDate && t.dueDate > todayKey && t.dueDate <= in3Days && !(t.snoozedUntil && new Date(t.snoozedUntil) > now));
                    const followUp = this.quotes.filter(q => {
                        if (q.status !== 'active') return false;
                        if (q.snoozedUntil && new Date(q.snoozedUntil) > now) return false;
                        const reminderDays = q.reminderInterval;
                        if (!reminderDays || reminderDays === 0) return false;
                        const startDate = q.createdDate ? new Date(q.createdDate) : this.parseDate(q.sentDate);
                        return Math.floor((now - startDate) / 86400000) >= reminderDays;
                    });

                    body.innerHTML = `
                        ${this.briefingSection('Overdue', overdue.map(t => this.briefingTaskItem(t, 'overdue')), 'Nothing overdue ‚Äî great start!')}
                        ${this.briefingSection('Due Today', dueToday.map(t => this.briefingTaskItem(t, 'today')), 'Nothing due today.')}
                        ${this.briefingSection('Coming Up (Next 3 Days)', upcoming.map(t => this.briefingTaskItem(t, 'upcoming')), 'Nothing coming up in the next 3 days.')}
                        ${followUp.length ? this.briefingSection('Quotes Needing Follow-up', followUp.map(q => this.briefingQuoteItem(q)), '') : ''}
                    `;

                } else {
                    title.textContent = 'End of Day';
                    subtitle.textContent = todayStr;

                    const completedToday = this.tasks.filter(t => {
                        if (!t.completed || !t.completedDate) return false;
                        return t.completedDate.split('T')[0] === todayKey;
                    });
                    const openedToday = this.quotes.filter(q => q.createdDate && q.createdDate.split('T')[0] === todayKey);
                    const closedToday = this.quotes.filter(q => q.closedDate && q.closedDate.split('T')[0] === todayKey);
                    const tomorrow = this.tasks.filter(t => !t.completed && t.dueDate === tomorrowKey && !(t.snoozedUntil && new Date(t.snoozedUntil) > now));
                    const stillOverdue = this.tasks.filter(t => !t.completed && t.dueDate && t.dueDate <= todayKey && !(t.snoozedUntil && new Date(t.snoozedUntil) > now));

                    body.innerHTML = `
                        ${this.briefingSection('Completed Today', completedToday.map(t => this.briefingTaskItem(t, 'done')), 'No tasks completed today.')}
                        ${this.briefingSection('Quotes Opened Today', openedToday.map(q => this.briefingQuoteItem(q)), 'No quotes opened today.')}
                        ${this.briefingSection('Quotes Closed Today', closedToday.map(q => this.briefingQuoteItem(q)), 'No quotes closed today.')}
                        ${this.briefingSection('Due Tomorrow', tomorrow.map(t => this.briefingTaskItem(t, 'upcoming')), 'Nothing due tomorrow.')}
                        ${stillOverdue.length ? this.briefingSection('Still Overdue', stillOverdue.map(t => this.briefingTaskItem(t, 'overdue')), '') : ''}
                    `;
                }

                panel.classList.add('open');
                overlay.classList.add('open');
            }

            closeBriefing() {
                document.getElementById('briefingPanel').classList.remove('open');
                document.getElementById('briefingOverlay').classList.remove('open');
            }

            briefingSection(heading, itemsHtml, emptyMsg) {
                const content = itemsHtml.length
                    ? itemsHtml.join('')
                    : `<div class="briefing-empty">${emptyMsg}</div>`;
                return `
                    <div class="briefing-section">
                        <div class="briefing-section-title">${heading}</div>
                        ${content}
                    </div>`;
            }

            briefingTaskItem(task, type) {
                const colors = { overdue: '#dc2626', today: '#ea580c', upcoming: 'var(--accent)', done: '#16a34a' };
                const color = colors[type] || 'var(--text-secondary)';
                const sub = task.customer || (task.dueDate ? this.parseDate(task.dueDate).toLocaleDateString() : 'Open-ended');
                return `<div class="briefing-item" onclick="taskManager.closeBriefing(); taskManager.goToTask(${task.id});">
                    <span class="briefing-item-title" style="color:${color}">${this.escapeHtml(task.title)}</span>
                    <span class="briefing-item-sub">${this.escapeHtml(sub)}</span>
                </div>`;
            }

            briefingQuoteItem(quote) {
                const statusLabel = quote.status === 'closed-won' ? 'Won' : quote.status === 'closed-lost' ? 'Lost' : 'Active';
                return `<div class="briefing-item" onclick="taskManager.closeBriefing(); taskManager.goToQuote(${quote.id});">
                    <span class="briefing-item-title">${this.escapeHtml(quote.reference)}</span>
                    <span class="briefing-item-sub">${this.escapeHtml(quote.customer)} ¬∑ ${statusLabel}</span>
                </div>`;
            }

            goToTask(id) {
                this.setView('list');
                this.setFilter('all');
                setTimeout(() => {
                    this.updateDisplay();
                    setTimeout(() => {
                        const cards = document.querySelectorAll('#taskList .task-card');
                        for (const card of cards) {
                            const btn = card.querySelector(`[onclick*="completeTask(${id})"]`);
                            if (btn) {
                                card.classList.add('expanded');
                                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                card.style.transition = 'box-shadow 0.3s ease';
                                card.style.boxShadow = '0 0 0 2px var(--accent)';
                                setTimeout(() => card.style.boxShadow = '', 1800);
                                break;
                            }
                        }
                    }, 80);
                }, 100);
            }

            goToQuote(id) {
                this.setView('quotes');
                this.setQuoteFilter('open');
                setTimeout(() => {
                    this.renderQuotes();
                    setTimeout(() => {
                        const cards = document.querySelectorAll('#quoteList .task-card');
                        for (const card of cards) {
                            if (card.querySelector(`[onclick*="deleteQuote(${id})"]`)) {
                                card.classList.add('expanded');
                                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                card.style.transition = 'box-shadow 0.3s ease';
                                card.style.boxShadow = '0 0 0 2px var(--accent)';
                                setTimeout(() => card.style.boxShadow = '', 1800);
                                break;
                            }
                        }
                    }, 80);
                }, 100);
            }

            goToFollowUpQuotes() {
                // Switch to quotes view
                this.setView('quotes');
                // Set filter to follow-up
                this.setQuoteFilter('follow-up');
                // Scroll to quotes view
                setTimeout(() => {
                    const quotesView = document.getElementById('quotesView');
                    if (quotesView) {
                        quotesView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }

            updateStats() {
                const today = new Date().toISOString().split('T')[0];
                const now = new Date();
                const activeTasks = this.tasks.filter(task => !task.completed);
                
                const dueToday = activeTasks.filter(task => {
                    if (!task.dueDate || task.dueDate > today) return false;
                    if (task.snoozedUntil && new Date(task.snoozedUntil) > now) return false;
                    return true;
                }).length;
                const openTasks = activeTasks.length;

                document.getElementById('dueToday').textContent = dueToday;
                document.getElementById('openTasks').textContent = openTasks;

                // Update follow-up quotes count in top stats
                const followUpQuotes = this.quotes.filter(q => {
                    if (q.status !== 'active') return false;
                    if (q.snoozedUntil && new Date(q.snoozedUntil) > now) return false;
                    const reminderDays = q.reminderInterval;
                    if (!reminderDays || reminderDays === 0) return false;
                    const startDate = q.createdDate ? new Date(q.createdDate) : this.parseDate(q.sentDate);
                    const daysSince = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                    return daysSince >= reminderDays;
                }).length;

                document.getElementById('followUpQuotesTop').textContent = followUpQuotes;
            }

            updateDate() {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
            }

            loadTasks() {
                const saved = localStorage.getItem('dailyTasks');
                return saved ? JSON.parse(saved) : [];
            }

            saveTasks() {
                localStorage.setItem('dailyTasks', JSON.stringify(this.tasks));
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Export quotes to Excel file
            exportData() {
                const exportData = this.quotes.map(quote => {
                    const sentDate = quote.sentDate ? this.parseDate(quote.sentDate) : null;
                    const closedDate = quote.closedDate ? new Date(quote.closedDate) : null;
                    const createdDate = quote.createdDate ? new Date(quote.createdDate) : null;
                    const daysSinceSent = sentDate ? Math.floor((new Date() - sentDate) / (1000 * 60 * 60 * 24)) : null;
                    
                    let status = 'Active';
                    if (quote.status === 'closed-won') status = 'Won';
                    else if (quote.status === 'closed-lost') status = 'Lost';

                    return {
                        'Reference': quote.reference,
                        'Customer': quote.customer,
                        'Amount': quote.amount || '',
                        'Type': quote.type === 'renewal' ? 'Renewal' : 'New Business',
                        'Sent Date': sentDate ? sentDate.toLocaleDateString() : '',
                        'Days Open': daysSinceSent !== null ? daysSinceSent : '',
                        'Status': status,
                        'Closed Date': closedDate ? closedDate.toLocaleDateString() : '',
                        'Point of Contact': quote.poc || '',
                        'Notes': quote.notes || '',
                        'Created': createdDate ? createdDate.toLocaleDateString() : ''
                    };
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Set column widths
                ws['!cols'] = [
                    { wch: 20 }, // Reference
                    { wch: 25 }, // Customer
                    { wch: 12 }, // Amount
                    { wch: 15 }, // Type
                    { wch: 12 }, // Sent Date
                    { wch: 10 }, // Days Open
                    { wch: 10 }, // Status
                    { wch: 12 }, // Closed Date
                    { wch: 20 }, // POC
                    { wch: 40 }, // Notes
                    { wch: 12 }  // Created
                ];

                XLSX.utils.book_append_sheet(wb, ws, 'Quotes');

                const date = new Date().toISOString().split('T')[0];
                const filename = `quotes-export-${date}.xlsx`;

                XLSX.writeFile(wb, filename);
            }

        }

        // Initialize the task manager
        const taskManager = new TaskManager();
        window.taskManager = taskManager;

        // Initialize Google Drive sync
        const googleDriveSync = new GoogleDriveSync();
        window.googleDriveSync = googleDriveSync;

        // Trigger sync when data changes
        const originalSaveTasks = taskManager.saveTasks.bind(taskManager);
        const originalSaveQuotes = taskManager.saveQuotes.bind(taskManager);

        taskManager.saveTasks = function() {
            originalSaveTasks();
            if (googleDriveSync.isSignedIn) {
                googleDriveSync.syncData();
            }
        };

        taskManager.saveQuotes = function() {
            originalSaveQuotes();
            if (googleDriveSync.isSignedIn) {
                googleDriveSync.syncData();
            }
        };

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
        <!-- Briefing Overlay -->
        <div class="briefing-overlay" id="briefingOverlay" onclick="taskManager.closeBriefing()"></div>

        <!-- Briefing Panel -->
        <div class="briefing-panel" id="briefingPanel">
            <div class="briefing-header">
                <div>
                    <div class="briefing-title" id="briefingTitle"></div>
                    <div class="briefing-subtitle" id="briefingSubtitle"></div>
                </div>
                <button class="briefing-close" onclick="taskManager.closeBriefing()">√ó</button>
            </div>
            <div class="briefing-body" id="briefingBody"></div>
        </div>

        <!-- PDF Preview Modal -->
        <div class="pdf-preview-modal" id="pdfPreviewModal" onclick="if(event.target === this) taskManager.closePDFPreview()">
            <div class="pdf-preview-container">
                <div class="pdf-preview-header">
                    <div class="pdf-preview-title" id="pdfPreviewTitle"></div>
                    <button class="pdf-preview-close" onclick="taskManager.closePDFPreview()">√ó</button>
                </div>
                <div class="pdf-preview-body" id="pdfPreviewBody"></div>
            </div>
        </div>

        <!-- PDF Context Menu -->
        <div class="pdf-context-menu" id="pdfContextMenu">
            <div class="pdf-context-item" id="pdfContextOpen">üìÑ Open in Google Drive</div>
            <div class="pdf-context-item" id="pdfContextDetach">üóëÔ∏è Remove PDF</div>
        </div>

</body>
</html>
